<?xml version="1.0" encoding="UTF-8"?>
<rss version="2.0" xmlns:atom="http://www.w3.org/2005/Atom">
    <channel>
        <title>3RDEYESYSTEM Technical Documentations</title>
        <description>써드아이시스템(3rdeyesys) 기술문서 사이트입니다 - Ncloud 프리미엄 파트너</description>
        <link>https://docs.3rdeyesys.com/</link>
        <atom:link href="https://docs.3rdeyesys.com/feed.xml" rel="self" type="application/rss+xml"/>
        <pubDate>Tue, 16 Aug 2022 18:02:39 +0900</pubDate>
        <lastBuildDate>Tue, 16 Aug 2022 18:02:39 +0900</lastBuildDate>
        <generator>Jekyll v4.2.2</generator>
        
        
        <item>
            <title>Kubernetes Service 클러스터 생성 및 제어 가이드 | Windows</title>
            <description>## 개요
Ncloud (네이버 클라우드) VPC 환경에서 Kubernetes(쿠버네티스) 서비스를 생성하고 **Windows 환경에서 제어하는 방법**에 대해 소개합니다.

## 쿠버네티스란?
쿠버네티스(Kubernetes, K8S)는 배포, 스케일링, 그리고 컨테이너화된 애플리케이션의 관리를 자동화 해주는 오픈 소스 컨테이너 오케스트레이션 엔진으로 
구글에서 처음 개발하기 시작했으나 현재는 구글이 오픈소스 프로젝트로 공개한 상태입니다.

## 특징
쿠버네티스는 다음과 같은 특징이 있으며, 자세한 내용은 쿠버네티스 공식 페이지를 참고하시기 바랍니다.

&lt;a href=&quot;https://kubernetes.io/ko/docs/home/&quot; target=&quot;_blank&quot; style=&quot;word-break:break-all;&quot;&gt;https://kubernetes.io/ko/docs/home/&lt;/a&gt;

- 서비스 디스커버리와 로드 밸런싱
- 스토리지 오케스트레이션
- 자동화된 롤아웃과 롤백
- 자동화된 빈 패킹(bin packing)
- 자동화된 복구(self-healing)
- 시크릿과 구성 관리


## 사전 준비
먼저 쿠버네티스 클러스터에 사용할 **전용 VPC와 Private 또는 Public Subnet 그리고, Load Balancer용 Subnet**이 필요합니다.

{% include image.html file=&quot;compute/kubernetes/ncp_server_kubernetes_start_guide_07.jpg&quot; width=&quot;845&quot; alt=&quot;Ncloud Kubernetes Service 클러스터 생성 및 제어하는 방법&quot; caption=&quot;&quot; %}

{% include callout-v2.html type=&quot;warning&quot; level=&quot;3&quot; content=&quot;IP 대역(10.0.0.0/8,172.16.0.0/12,192.168.0.0/16) 내에서 /17~/26 범위의 Private 또는 Public Subnet, 로드밸런서 전용 Subnet이 필요합니다.&lt;br/&gt;&lt;br/&gt;
Docker Bridge 대역의 충돌을 방지하기 위해 172.17.0.0/16 범위 내의 Private Subnet, 로드밸런서 전용Subnet은 선택할 수 없습니다.&quot; %}


## 클러스터 생성 

VPC와 Subnet이 준비되었다면, 다음으로 [Kubernetes Sevice] - [Cluster]에서 생성하기를 클릭합니다.

{% include image.html file=&quot;compute/kubernetes/ncp_server_kubernetes_start_guide_09.jpg&quot; width=&quot;500&quot; alt=&quot;Ncloud Kubernetes Service 클러스터 생성 및 제어하는 방법&quot; caption=&quot;&quot; %}

## 클러스터 설정
생성할 클러스터의 정보를 설정해줍니다. 
**네트워크 타입은 Private과 Public 중에서 선택**할 수 있습니다.

{% include callout-v2.html type=&quot;info&quot; level=&quot;2&quot; content=&quot;Kubernetes Service를 위한 ACG는 자동으로 생성됩니다.&quot; %}
{% include callout-v2.html type=&quot;primary&quot; level=&quot;2&quot; content=&quot;현재 지원되고 있는 Kubernetes 버전은 [**1.21.9**], [**1.22.9**] 입니다.&quot;%}

{% include image.html file=&quot;compute/kubernetes/ncp_server_kubernetes_start_guide_01.jpg&quot; width=&quot;845&quot; alt=&quot;Ncloud Kubernetes Service 클러스터 생성 및 제어하는 방법&quot; caption=&quot;&quot; %}


### NAT Gateway 생성
`Private Subnet을 선택했을 경우`에는 아래와 같이 NAT Gateway 생성 안내 팝업이 나타나는데,  
NAT Gateway를 생성해야 아웃바운드 트래픽을 활성화할 수 있기 때문입니다.

{% include image.html file=&quot;compute/kubernetes/ncp_server_kubernetes_start_guide_10.jpg&quot; width=&quot;490&quot; alt=&quot;Ncloud Kubernetes Service 클러스터 생성 및 제어하는 방법&quot; caption=&quot;&quot; %}

팝업에서 링크를 클릭해서 NAT Gateway 화면으로 이동해 NAT Gateway를 생성합니다.

{% include image.html file=&quot;compute/kubernetes/ncp_server_kubernetes_start_guide_11.jpg&quot; width=&quot;845&quot; alt=&quot;Ncloud Kubernetes Service 클러스터 생성 및 제어하는 방법&quot; caption=&quot;&quot; %}

## 노드풀 설정
노드풀 이름을 입력하고, 서버 이미지와 서버 타입을 선택하고 [추가] 버튼을 클릭합니다.

{% include callout-v2.html type=&quot;info&quot; level=&quot;2&quot; content=&quot;현재 지원되고 있는 OS는 [**ubuntu16.04**], [**ubuntu18.04**] 입니다.&quot;%}

{% include image.html file=&quot;compute/kubernetes/ncp_server_kubernetes_start_guide_02.jpg&quot; width=&quot;770&quot; alt=&quot;Ncloud Kubernetes Service 클러스터 생성 및 제어하는 방법&quot; caption=&quot;&quot; %}


## 로그인키 설정
다음으로 워커노드의 로그인키를 설정 합니다.

{% include image.html file=&quot;compute/kubernetes/ncp_server_kubernetes_start_guide_03.jpg&quot; width=&quot;770&quot; alt=&quot;Ncloud Kubernetes Service 클러스터 생성 및 제어하는 방법&quot; caption=&quot;&quot; %}

## 최종 확인
설정 정보를 최종적으로 확인한 후 생성버튼을 클릭하여 클러스터를 생성합니다.

{% include callout-v2.html type=&quot;warning&quot; level=&quot;2&quot; content=&quot;쿠버네티스 클러스터 생성은 20분 정도 소요되므로 여유를 갖고 기다리시면 됩니다.&quot;%}

{% include image.html file=&quot;compute/kubernetes/ncp_server_kubernetes_start_guide_04.jpg&quot; width=&quot;845&quot; alt=&quot;Ncloud Kubernetes Service 클러스터 생성 및 제어하는 방법&quot; caption=&quot;&quot; %}


## 생성 완료
생성이 완료되면 아래와 같이 클러스터와 노드풀의 정보를 확인할 수 있습니다.  
클러스터 정보 중에서 클러스터 **UUID는 아래쪽에서 IAM 인증 Kubeconifg 파일을 생성할 때 필요**하니 확인해두시기 바랍니다.

{% include image.html file=&quot;containers/ncloud-containers-kubernetes-start-guide-12.png&quot; width=&quot;845&quot; alt=&quot;Ncloud Kubernetes Service 클러스터 생성 및 제어하는 방법&quot; caption=&quot;&quot; %}

[Server] 메뉴에 가면 노드풀 설정에 따라 생성된 서버를 확인할 수 있습니다.  
(서버 이름은 노드풀 이름으로 입력한 문자열 기준으로 생성되는데, 여기서는 test123-O-OOO 이런 식으로 생성되었습니다.)

{% include image.html file=&quot;containers/ncloud-containers-kubernetes-start-guide-13.png&quot; width=&quot;845&quot; alt=&quot;Ncloud Kubernetes Service 클러스터 생성 및 제어하는 방법&quot; caption=&quot;&quot; %}

## IAM 인증 설정
클러스터를 제어하기 위해서는 네이버 클라우드 쿠버네티스 서비스에서 제공하는 IAM 인증을 설정해야 합니다.

### ncp-iam-authenticator 설치
Ncloud에서 제공하는 ncp-iam-authenticator 바이너리를 통해 iam 인증 config 파일을 생성 할 수 있습니다.

- ncp-iam-authenticator 바이너리를 다운로드 합니다.

``` powershell
&gt; curl -o ncp-iam-authenticator.exe https://kr.object.ncloudstorage.com/nks-download/ncp-iam-authenticator/v1.0.5/windows/amd64/ncp-iam-authenticator.exe
```
{% include image.html file=&quot;containers/ncloud-containers-kubernetes-start-guide-25.png&quot; width=&quot;843&quot; alt=&quot;Ncloud Kubernetes Service 클러스터 생성 및 제어하는 방법&quot; caption=&quot;&quot; %}

- ncp-iam-authenticator가 정상 작동 하는지 테스트 합니다. 

``` powershell
&gt; ncp-iam-authenticator help
```

{% include image.html file=&quot;containers/ncloud-containers-kubernetes-start-guide-26.png&quot; width=&quot;843&quot; alt=&quot;Ncloud Kubernetes Service 클러스터 생성 및 제어하는 방법&quot; caption=&quot;&quot; %}

## API 인증키 생성
네이버 클라우드 포탈 -&gt; 마이페이지 -&gt; 계정관리 -&gt; 인증키 관리 - API 인증키 관리 메뉴에서 Access Key ID와 Secret Key를 가져오셔야 하며, 아직 만들어진 Key가 없다면 새로 만드셔야 합니다.

{% include image.html file=&quot;api/ncloud_api_auth_key_create.png&quot; width=&quot;770&quot; alt=&quot;Ncloud API 인증키 생성 방법&quot; caption=&quot;&quot; %}

## Kubeconfig 파일 생성
API 인증키를 2가지 방법 중 하나를 이용해 환경변수에 등록합니다.

**1. OS 환경 변수 설정**

``` powershell
&gt; SET NCLOUD_ACCESS_KEY={Ncloud API AccessKey}
&gt; SET NCLOUD_SECRET_KEY={Ncloud API SecretKey}
&gt; SET NCLOUD_API_GW=https://ncloud.apigw.ntruss.com
```
{% include image.html file=&quot;containers/ncloud-containers-kubernetes-start-guide-27.png&quot; width=&quot;843&quot; alt=&quot;Ncloud Kubernetes Service 클러스터 생성 및 제어하는 방법&quot; caption=&quot;&quot; %}


**2. 사용자 계정 홈 폴더에 configure 설정**  
Windows 사용자 계정 폴더에 .ncloud 폴더를 만들고 아래와 같은 내용으로 configure 파일을 생성합니다.

``` powershell
&gt; mkdir C:\Users\{User Account}\.ncloud
&gt; copy con C:\Users\{User Account}\.ncloud\configure
[DEFAULT]
ncloud_access_key_id = {Ncloud API AccessKey}
ncloud_secret_access_key = {Ncloud API SecretKey}
ncloud_api_url = https://ncloud.apigw.ntruss.com
^Z
```
{% include image.html file=&quot;containers/ncloud-containers-kubernetes-start-guide-28.png&quot; width=&quot;843&quot; alt=&quot;Ncloud Kubernetes Service 클러스터 생성 및 제어하는 방법&quot; caption=&quot;&quot; %}

**3. Kubeconifg 파일 생성**  
환경변수에 등록이 되었다면 파일을 생성 할 차례입니다.  
아래 명령어로 클러스터에 대한 IAM 인증 Kubeconifg 파일을 생성합니다.

{% include callout-v2.html type=&quot;info&quot; level=&quot;2&quot; content=&quot;클러러스터 UUID 값은 클러스터 상세보기의 [클러스터 이름 (UUID)] 에서  확인 할수 있습니다.&quot; %}

``` powershell
&gt; ncp-iam-authenticator create-kubeconfig --region &lt;region-code&gt; --clusterUuid &lt;cluster-uuid&gt; --output &lt;FileName&gt;.yaml

## 예시
&gt; ncp-iam-authenticator create-kubeconfig --region KR --clusterUuid 12345678-1234-1234-1234-1234567890 --output kubeconfig.yaml
```

{% include image.html file=&quot;containers/ncloud-containers-kubernetes-start-guide-29.png&quot; width=&quot;843&quot; alt=&quot;Ncloud Kubernetes Service 클러스터 생성 및 제어하는 방법&quot; caption=&quot;&quot; %}


## kubectl 설치
쿠버네티스 클러스터를 제어할 kubectl을 설치하기 위해 필요한 파일을 다운로드 받고, 버전 정보를 확인합니다.

아래 두가지 방법 중에 하나를 선택해 다운로드 받으시면 됩니다.

&lt;a href=&quot;https://dl.k8s.io/release/v1.24.0/bin/windows/amd64/kubectl.exe&quot; target=&quot;_self&quot; style=&quot;word-break:break-all;&quot;&gt;Download the latest release v1.24.0&lt;/a&gt;

``` bash
&gt; curl -LO https://dl.k8s.io/release/v1.24.0/bin/windows/amd64/kubectl.exe
```

``` powershell
&gt; kubectl version --client --output=yaml
```

{% include image.html file=&quot;containers/ncloud-containers-kubernetes-start-guide-30.png&quot; width=&quot;843&quot; alt=&quot;Ncloud Kubernetes Service 클러스터 생성 및 제어하는 방법&quot; caption=&quot;&quot; %}


## kubectl 실행
생성한 IAM 인증 kubeconfig 파일을 이용하여 kubectl 명령어를 테스트하여 정상 동작 하는지 확인 합니다.  
실행하면 아래와 같이 현재 동작 중인 노드 서버 리스트를 확인할 수 있습니다.

``` powershell
&gt; kubectl get node --kubeconfig kubeconfig.yaml
```
{% include image.html file=&quot;containers/ncloud-containers-kubernetes-start-guide-31.png&quot; width=&quot;843&quot; alt=&quot;Ncloud Kubernetes Service 클러스터 생성 및 제어하는 방법&quot; caption=&quot;&quot; %}

### 실행 명령어 단축
위와 같은 kubectl 명령은 뒤쪽에 kubeconfig 환경 설정 파일까지 입력해야 해서 다소 불편한데, 간단하게 줄일 수 있는 방법이 있습니다.  

우선 만들어진 kubeconfig.yaml 파일을 .kube/ 디렉토리 아래에 config로 이름을 바꾸어 이동 혹은 복사 합니다.

``` powershell
&gt; copy kubeconfig.yaml .kube\config
```

이렇게 하면 Kubectl을 사용 시 아래와 같이 --kuebeconfig 명령어 없이 사용 할 수 있습니다.

``` powershell
&gt; kubectl get node
```

{% include image.html file=&quot;containers/ncloud-containers-kubernetes-start-guide-32.png&quot; width=&quot;843&quot; alt=&quot;Ncloud Kubernetes Service 클러스터 생성 및 제어하는 방법&quot; caption=&quot;&quot; %}


## 참고 URL
1. 쿠버네티스 사용 가이드
	- &lt;a href=&quot;https://guide.ncloud-docs.com/docs/k8s-k8soverview&quot; target=&quot;_blank&quot; style=&quot;word-break:break-all;&quot;&gt;https://guide.ncloud-docs.com/docs/k8s-k8soverview&lt;/a&gt;

2. 클러스터 이용 가이드
	- &lt;a href=&quot;https://guide.ncloud-docs.com/docs/k8s-k8suse-cluster&quot; target=&quot;_blank&quot; style=&quot;word-break:break-all;&quot;&gt;https://guide.ncloud-docs.com/docs/k8s-k8suse-cluster&lt;/a&gt;

3. kubectl 설치 가이드
	- &lt;a href=&quot;https://guide.ncloud-docs.com/docs/k8s-k8sstart#Kubectl%EC%84%A4%EC%B9%98&quot; target=&quot;_blank&quot; style=&quot;word-break:break-all;&quot;&gt;https://guide.ncloud-docs.com/docs/k8s-k8sstart#Kubectl&lt;/a&gt;

4. Linux 환경에서 쿠버네티스 제어하기
	- &lt;a href=&quot;/containers/ncloud-containers-kubernetes-service-start-guide-linux.html&quot; target=&quot;_blank&quot; style=&quot;word-break:break-all;&quot;&gt;https://docs.3rdeyesys.com/containers/ncloud-containers-kubernetes-service-start-guide-linux.html&lt;/a&gt;    
</description>
            <pubDate>Tue, 16 Aug 2022 00:00:00 +0900</pubDate>
            <link>https://docs.3rdeyesys.com/containers/ncloud-containers-kubernetes-service-start-guide-windows.html</link>
            <guid isPermaLink="true">https://docs.3rdeyesys.com/containers/ncloud-containers-kubernetes-service-start-guide-windows.html</guid>
            
            <category>kubernetes</category>
            
            <category>vpc</category>
            
            
        </item>
        
        <item>
            <title>Object Storage 접속용 Windows Client Tool - S3 Browser</title>
            <description>## 개요
네이버 클라우드의 Object Storage에 접속, 관리하는 방법은 aws cli 등 여러가지 있지만 Windows PC에서 간편하게 접속해서 관리할 수 있는 클라이언트 툴이 몇개 있습니다.  
그 중에서 이번에는 S3 Browser의 사용법에 대해 간단히 정리해보겠습니다.

## S3 Browser
S3 Browser는 Amazon S3 and Amazon CloudFront를 위한 클라이언트입니다
이 버전은 무료버전이기는 하지만, 정확히는 **personal use only**, **non-commecial use only**라고 명시되어 있습니다.  
그래서 라이선스와 관계없이 사용 가능하고, 더 많은 기능이 포함된 유료 버전도 있습니다. 

상세한 정보와 다운로드는 아래 링크에서 확인하시면 됩니다.

&lt;a href=&quot;https://s3browser.com/&quot; target=&quot;_blank&quot; style=&quot;word-break:break-all;&quot;&gt;https://s3browser.com/&lt;/a&gt;


## 사용법

프로그램을 다운 받아서 설치하고, 실행을 하면 여러 종류의 스토리지 중에서 원하는 것을 선택하게 됩니다.  
이 클라이언트는 AWS S3를 위한 것으로 CloudBerry Explorer와는 다르게 AWS의 다양한 S3 서비스들만 접속이 가능한데, 이용 가능한 스토리지 리스트는 마지막에서 정리해보겠습니다. 

{% include image.html file=&quot;storage/ncp_storage_object_storage_s3_client_s3browser_01.jpg&quot; width=&quot;850&quot; alt=&quot;Ncloud Object Storage 접속용 Windows Client Tool - S3 Browser 사용 방법&quot; caption=&quot;&quot; %}


Account Type은  **S3 Compatible Storage**를 선택하면 됩니다.  
- Account name: 여기는 알아보기 쉬운 이름을 적으면 됩니다. 예를 들어 Naver Cloud
- REST Endpoint: 여기는 네이버 클라우드의 endpoint-url을 적습니다. **kr.object.ncloudstorage.com**
- Access Key ID: 여기는 Access Key ID
- Secret Access Key: 여기는 Secret Key

{% include image.html file=&quot;storage/ncp_storage_object_storage_s3_client_s3browser_02.jpg&quot; width=&quot;718&quot; alt=&quot;Ncloud Object Storage 접속용 Windows Client Tool - S3 Browser 사용 방법&quot; caption=&quot;&quot; %}

{% include callout_v2.html type=&quot;success&quot; level=&quot;1&quot; content=&quot;네이버 클라우드 포탈 -&gt; 마이페이지 -&gt; 계정관리 -&gt; 인증키 관리 - API 인증키 관리 메뉴에서 Access Key ID와 Secret Key를 가져오셔야 하며, 아직 만들어진 Key가 없다면 새로 만드셔야 합니다.&quot; %}


계정 정보를 입력하고 접속을 하면 버킷 리스트가 나타나고 원하는 버킷을 선택해서 들어가면 다음처럼 파일들을 확인할 수 있습니다.

{% include image.html file=&quot;storage/ncp_storage_object_storage_s3_client_s3browser_03.jpg&quot; width=&quot;850&quot; alt=&quot;Ncloud Object Storage 접속용 Windows Client Tool - S3 Browser 사용 방법&quot; caption=&quot;&quot; %}


Object Storage에 있는 파일을 로컬PC로 가져오려면 원하는 파일을 선택하고 마우스 오른쪽 버튼을 눌러서 **Download** 명령을 선택하면 됩니다.

{% include image.html file=&quot;storage/ncp_storage_object_storage_s3_client_s3browser_04.jpg&quot; width=&quot;850&quot; alt=&quot;Ncloud Object Storage 접속용 Windows Client Tool - S3 Browser 사용 방법&quot; caption=&quot;&quot; %}


그 외 여러 가지 기능들이 있는데 그리 어려운 기능은 아니므로 직접 사용해보시면 금방 알 수 있습니다.

마지막으로 S3 Browser로 접속 가능한 S3 리스트를 확인해보겠습니다.

{% include image.html file=&quot;storage/ncp_storage_object_storage_s3_client_s3browser_05.jpg&quot; width=&quot;717&quot; alt=&quot;Ncloud Object Storage 접속용 Windows Client Tool - S3 Browser 사용 방법&quot; caption=&quot;&quot; %}

- Amazon S3 Storage
- S3 Compatible Storage
- Amazon S3 in China
- Amazon S3 GovCloud Storage
- Amazon S3 GovCloud Storage (FIPS 140-2)
- Amazon S3 via EC2 IAM Role
- Amazon S3 via AssumeRole
- Amazon S3 (Credentials from Environment Variables)
- Amazon S3 (Credentials from AWS Config or Credential file)


## CloudBerry Explorer
또 다른 클라이언트인 CloudBerry Explorer입니다. 자세한  내용은 아래 링크에서 확인 가능합니다.

&lt;a href=&quot;/storage/ncloud_storage_object_storage_s3_client_cloudberry_explorer.html&quot; target=&quot;_blank&quot; style=&quot;word-break:break-all;&quot;&gt;Object Storage 접속용 Windows Client Tool - CloudBerry Explorer&lt;/a&gt;


## 참고 URL
1.  S3 Browser 홈페이지
	- &lt;a href=&quot;https://s3browser.com/&quot; target=&quot;_blank&quot; style=&quot;word-break:break-all;&quot;&gt;https://s3browser.com/&lt;/a&gt;

2.  S3 Browser S3-Compatible Storages 설정 가이드
	- &lt;a href=&quot;https://s3browser.com/s3-compatible-storage.aspx&quot; target=&quot;_blank&quot; style=&quot;word-break:break-all;&quot;&gt;https://s3browser.com/s3-compatible-storage.aspx&lt;/a&gt;</description>
            <pubDate>Tue, 16 Aug 2022 00:00:00 +0900</pubDate>
            <link>https://docs.3rdeyesys.com/storage/ncloud_storage_object_storage_s3_client_s3browser.html</link>
            <guid isPermaLink="true">https://docs.3rdeyesys.com/storage/ncloud_storage_object_storage_s3_client_s3browser.html</guid>
            
            <category>object_storage</category>
            
            <category>backup</category>
            
            
        </item>
        
        <item>
            <title>Kubernetes Service 클러스터 생성 및 제어 가이드 | Linux</title>
            <description>## 개요
Ncloud (네이버 클라우드) VPC 환경에서 Kubernetes(쿠버네티스) 서비스를 생성하고 **Linux 환경에서 제어하는 방법**에 대해 소개합니다.

## 쿠버네티스란?
쿠버네티스(Kubernetes, K8S)는 배포, 스케일링, 그리고 컨테이너화된 애플리케이션의 관리를 자동화 해주는 오픈 소스 컨테이너 오케스트레이션 엔진으로 
구글에서 처음 개발하기 시작했으나 현재는 구글이 오픈소스 프로젝트로 공개한 상태입니다.

## 특징
쿠버네티스는 다음과 같은 특징이 있으며, 자세한 내용은 쿠버네티스 공식 페이지를 참고하시기 바랍니다.

&lt;a href=&quot;https://kubernetes.io/ko/docs/home/&quot; target=&quot;_blank&quot; style=&quot;word-break:break-all;&quot;&gt;https://kubernetes.io/ko/docs/home/&lt;/a&gt;

- 서비스 디스커버리와 로드 밸런싱
- 스토리지 오케스트레이션
- 자동화된 롤아웃과 롤백
- 자동화된 빈 패킹(bin packing)
- 자동화된 복구(self-healing)
- 시크릿과 구성 관리


## 사전 준비
먼저 쿠버네티스 클러스터에 사용할 **전용 VPC와 Private 또는 Public Subnet 그리고, Load Balancer용 Subnet**이 필요합니다.

{% include image.html file=&quot;compute/kubernetes/ncp_server_kubernetes_start_guide_07.jpg&quot; width=&quot;845&quot; alt=&quot;Ncloud Kubernetes Service 클러스터 생성 및 제어하는 방법&quot; caption=&quot;&quot; %}

{% include callout-v2.html type=&quot;warning&quot; level=&quot;3&quot; content=&quot;IP 대역(10.0.0.0/8,172.16.0.0/12,192.168.0.0/16) 내에서 /17~/26 범위의 Private 또는 Public Subnet, 로드밸런서 전용 Subnet이 필요합니다.&lt;br/&gt;&lt;br/&gt;
Docker Bridge 대역의 충돌을 방지하기 위해 172.17.0.0/16 범위 내의 Private Subnet, 로드밸런서 전용Subnet은 선택할 수 없습니다.&quot; %}


## 클러스터 생성 

VPC와 Subnet이 준비되었다면, 다음으로 [Kubernetes Sevice] - [Cluster]에서 생성하기를 클릭합니다.

{% include image.html file=&quot;compute/kubernetes/ncp_server_kubernetes_start_guide_09.jpg&quot; width=&quot;500&quot; alt=&quot;Ncloud Kubernetes Service 클러스터 생성 및 제어하는 방법&quot; caption=&quot;&quot; %}

## 클러스터 설정
생성할 클러스터의 정보를 설정해줍니다. 
**네트워크 타입은 Private과 Public 중에서 선택**할 수 있습니다.

{% include callout-v2.html type=&quot;info&quot; level=&quot;2&quot; content=&quot;Kubernetes Service를 위한 ACG는 자동으로 생성됩니다.&quot; %}
{% include callout-v2.html type=&quot;primary&quot; level=&quot;2&quot; content=&quot;현재 지원되고 있는 Kubernetes 버전은 [**1.21.9**], [**1.22.9**] 입니다.&quot;%}

{% include image.html file=&quot;compute/kubernetes/ncp_server_kubernetes_start_guide_01.jpg&quot; width=&quot;845&quot; alt=&quot;Ncloud Kubernetes Service 클러스터 생성 및 제어하는 방법&quot; caption=&quot;&quot; %}

### NAT Gateway 생성
`Private Subnet을 선택했을 경우`에는 아래와 같이 NAT Gateway 생성 안내 팝업이 나타나는데,  
NAT Gateway를 생성해야 아웃바운드 트래픽을 활성화할 수 있기 때문입니다.

{% include image.html file=&quot;compute/kubernetes/ncp_server_kubernetes_start_guide_10.jpg&quot; width=&quot;490&quot; alt=&quot;Ncloud Kubernetes Service 클러스터 생성 및 제어하는 방법&quot; caption=&quot;&quot; %}

팝업에서 링크를 클릭해서 NAT Gateway 화면으로 이동해 NAT Gateway를 생성합니다.

{% include image.html file=&quot;compute/kubernetes/ncp_server_kubernetes_start_guide_11.jpg&quot; width=&quot;845&quot; alt=&quot;Ncloud Kubernetes Service 클러스터 생성 및 제어하는 방법&quot; caption=&quot;&quot; %}

## 노드풀 설정
노드풀 이름을 입력하고, 서버 이미지와 서버 타입을 선택하고 [추가] 버튼을 클릭합니다.

{% include callout-v2.html type=&quot;info&quot; level=&quot;2&quot; content=&quot;현재 지원되고 있는 OS는 [**ubuntu16.04**], [**ubuntu18.04**] 입니다.&quot;%}

{% include image.html file=&quot;compute/kubernetes/ncp_server_kubernetes_start_guide_02.jpg&quot; width=&quot;770&quot; alt=&quot;Ncloud Kubernetes Service 클러스터 생성 및 제어하는 방법&quot; caption=&quot;&quot; %}


## 로그인키 설정
다음으로 워커노드의 로그인키를 설정 합니다.

{% include image.html file=&quot;compute/kubernetes/ncp_server_kubernetes_start_guide_03.jpg&quot; width=&quot;770&quot; alt=&quot;Ncloud Kubernetes Service 클러스터 생성 및 제어하는 방법&quot; caption=&quot;&quot; %}

## 최종 확인
설정 정보를 최종적으로 확인한 후 생성버튼을 클릭하여 클러스터를 생성합니다.

{% include callout-v2.html type=&quot;warning&quot; level=&quot;2&quot; content=&quot;쿠버네티스 클러스터 생성은 20분 정도 소요되므로 여유를 갖고 기다리시면 됩니다.&quot;%}

{% include image.html file=&quot;compute/kubernetes/ncp_server_kubernetes_start_guide_04.jpg&quot; width=&quot;845&quot; alt=&quot;Ncloud Kubernetes Service 클러스터 생성 및 제어하는 방법&quot; caption=&quot;&quot; %}


## 생성 완료
생성이 완료되면 아래와 같이 클러스터와 노드풀의 정보를 확인할 수 있습니다.  
클러스터 정보 중에서 클러스터 **UUID는 아래쪽에서 IAM 인증 Kubeconifg 파일을 생성할 때 필요**하니 확인해두시기 바랍니다.

{% include image.html file=&quot;containers/ncloud-containers-kubernetes-start-guide-12.png&quot; width=&quot;845&quot; alt=&quot;Ncloud Kubernetes Service 클러스터 생성 및 제어하는 방법&quot; caption=&quot;&quot; %}

[Server] 메뉴에 가면 노드풀 설정에 따라 생성된 서버를 확인할 수 있습니다.  
(서버 이름은 노드풀 이름으로 입력한 문자열 기준으로 생성되는데, 여기서는 test123-O-OOO 이런 식으로 생성되었습니다.)

그리고, 추가로 테스트를 위한 CentOS 서버(k8s-test)를 생성했습니다.

{% include image.html file=&quot;containers/ncloud-containers-kubernetes-start-guide-13.png&quot; width=&quot;845&quot; alt=&quot;Ncloud Kubernetes Service 클러스터 생성 및 제어하는 방법&quot; caption=&quot;&quot; %}

## IAM 인증 설정
클러스터를 제어하기 위해서는 네이버 클라우드 쿠버네티스 서비스에서 제공하는 IAM 인증을 설정해야 합니다.

### ncp-iam-authenticator 설치
Ncloud에서 제공하는 ncp-iam-authenticator 바이너리를 통해 iam 인증 config 파일을 생성 할 수 있습니다.

- ncp-iam-authenticator 바이너리를 다운로드 합니다.

```bash
~# curl -o ncp-iam-authenticator https://kr.object.ncloudstorage.com/nks-download/ncp-iam-authenticator/v1.0.5/linux/amd64/ncp-iam-authenticator
```
{% include image.html file=&quot;containers/ncloud-containers-kubernetes-start-guide-14.png&quot; width=&quot;840&quot; alt=&quot;Ncloud Kubernetes Service 클러스터 생성 및 제어하는 방법&quot; caption=&quot;&quot; %}


- 다운받은 바이너리에 실행 권한을 추가 합니다.

```bash
~# chmod +x ./ncp-iam-authenticator
```
{% include image.html file=&quot;containers/ncloud-containers-kubernetes-start-guide-15.png&quot; width=&quot;840&quot; alt=&quot;Ncloud Kubernetes Service 클러스터 생성 및 제어하는 방법&quot; caption=&quot;&quot; %}


- bin/ncp-iam-authenticator 파일을 생성하고  $PATH에 추가합니다.
- bash Profile에 추가 합니다.

```bash
~# mkdir -p $HOME/bin &amp;&amp; cp ./ncp-iam-authenticator $HOME/bin/ncp-iam-authenticator &amp;&amp; export PATH=$PATH:$HOME/bin
```
```bash
~# echo &apos;export PATH=$PATH:$HOME/bin&apos; &gt;&gt; ~/.bash_profile
```

{% include image.html file=&quot;containers/ncloud-containers-kubernetes-start-guide-16.png&quot; width=&quot;840&quot; alt=&quot;Ncloud Kubernetes Service 클러스터 생성 및 제어하는 방법&quot; caption=&quot;&quot; %}


- ncp-iam-authenticator가 정상 작동 하는지 테스트 합니다. 

```bash
~# ncp-iam-authenticator help
```

{% include image.html file=&quot;containers/ncloud-containers-kubernetes-start-guide-17.png&quot; width=&quot;840&quot; alt=&quot;Ncloud Kubernetes Service 클러스터 생성 및 제어하는 방법&quot; caption=&quot;&quot; %}

## API 인증키 생성
네이버 클라우드 포탈 -&gt; 마이페이지 -&gt; 계정관리 -&gt; 인증키 관리 - API 인증키 관리 메뉴에서 Access Key ID와 Secret Key를 가져오셔야 하며, 아직 만들어진 Key가 없다면 새로 만드셔야 합니다.

{% include image.html file=&quot;api/ncloud_api_auth_key_create.png&quot; width=&quot;770&quot; alt=&quot;Ncloud API 인증키 생성 방법&quot; caption=&quot;&quot; %}

## Kubeconfig 파일 생성
API 인증키를 2가지 방법 중 하나를 이용해 환경변수에 등록합니다.

**1. OS 환경 변수 설정**

```bash
~# export NCLOUD_ACCESS_KEY={Ncloud API AccessKey}
~# export NCLOUD_SECRET_KEY={Ncloud API SecretKey}
~# export NCLOUD_API_GW=https://ncloud.apigw.ntruss.com
```
{% include image.html file=&quot;containers/ncloud-containers-kubernetes-start-guide-18.png&quot; width=&quot;840&quot; alt=&quot;Ncloud Kubernetes Service 클러스터 생성 및 제어하는 방법&quot; caption=&quot;&quot; %}


**2. 사용자 환경 홈 디렉리에 configure 설정**

```bash
~# mkdir .ncloud 
~# cat &lt;&lt; EOF &gt; configure
[DEFAULT]
ncloud_access_key_id = {Ncloud API AccessKey}
ncloud_secret_access_key = {Ncloud API SecretKey}
ncloud_api_url = https://ncloud.apigw.ntruss.com
EOF
```
{% include image.html file=&quot;containers/ncloud-containers-kubernetes-start-guide-19.png&quot; width=&quot;840&quot; alt=&quot;Ncloud Kubernetes Service 클러스터 생성 및 제어하는 방법&quot; caption=&quot;&quot; %}

**3. Kubeconifg 파일 생성**  
환경변수에 등록이 되었다면 파일을 생성 할 차례입니다.  
아래 명령어로 클러스터에 대한 IAM 인증 Kubeconifg 파일을 생성합니다.

{% include callout-v2.html type=&quot;info&quot; level=&quot;2&quot; content=&quot;클러러스터 UUID 값은 클러스터 상세보기의 [클러스터 이름 (UUID)] 에서  확인 할수 있습니다.&quot; %}

``` bash
~# ncp-iam-authenticator create-kubeconfig --region &lt;region-code&gt; --clusterUuid &lt;cluster-uuid&gt; --output &lt;FileName&gt;.yaml

## 예시
~# ncp-iam-authenticator create-kubeconfig --region KR --clusterUuid 12345678-1234-1234-1234-1234567890 --output kubeconfig.yaml
```

{% include image.html file=&quot;containers/ncloud-containers-kubernetes-start-guide-20.png&quot; width=&quot;840&quot; alt=&quot;Ncloud Kubernetes Service 클러스터 생성 및 제어하는 방법&quot; caption=&quot;&quot; %}


## kubectl 설치
쿠버네티스 클러스터를 제어할 kubectl을 설치하기 위해 필요한 파일을 다운로드 받습니다.

``` bash
~# curl -LO &quot;https://dl.k8s.io/release/$(curl -L -s https://dl.k8s.io/release/stable.txt)/bin/linux/amd64/kubectl&quot;
```

{% include image.html file=&quot;containers/ncloud-containers-kubernetes-start-guide-21.png&quot; width=&quot;840&quot; alt=&quot;Ncloud Kubernetes Service 클러스터 생성 및 제어하는 방법&quot; caption=&quot;&quot; %}

다운 받은 파일을 설치합니다.

``` bash
~# sudo install -o root -g root -m 0755 kubectl /usr/local/bin/kubectl

# 버전 확인
~# kubectl version --client --output=yaml
```

{% include image.html file=&quot;containers/ncloud-containers-kubernetes-start-guide-22.png&quot; width=&quot;840&quot; alt=&quot;Ncloud Kubernetes Service 클러스터 생성 및 제어하는 방법&quot; caption=&quot;&quot; %}



## kubectl 실행
생성한 IAM 인증 kubeconfig 파일을 이용하여 kubectl 명령어를 테스트하여 정상 동작 하는지 확인 합니다.  
실행하면 아래와 같이 현재 동작 중인 노드 서버 리스트를 확인할 수 있습니다.

```bash
~# kubectl get node --kubeconfig kubeconfig.yaml
```
{% include image.html file=&quot;containers/ncloud-containers-kubernetes-start-guide-23.png&quot; width=&quot;840&quot; alt=&quot;Ncloud Kubernetes Service 클러스터 생성 및 제어하는 방법&quot; caption=&quot;&quot; %}

### 실행 명령어 단축
위와 같은 kubectl 명령은 뒤쪽에 kubeconfig 환경 설정 파일까지 입력해야 해서 다소 불편한데, 간단하게 줄일 수 있는 방법이 있습니다.  

우선 만들어진 kubeconfig.yaml 파일을 .kube/ 디렉토리 아래에 config로 이름을 바꾸어 이동 혹은 복사 합니다.

```bash
~# cp kubeconfig.yaml .kube/config
```

이렇게 하면 Kubectl을 사용 시 아래와 같이 --kuebeconfig 명령어 없이 사용 할 수 있습니다.

```bash
~# kubectl get node
```

{% include image.html file=&quot;containers/ncloud-containers-kubernetes-start-guide-24.png&quot; width=&quot;840&quot; alt=&quot;Ncloud Kubernetes Service 클러스터 생성 및 제어하는 방법&quot; caption=&quot;&quot; %}


## 참고 URL
1. 쿠버네티스 사용 가이드
	- &lt;a href=&quot;https://guide.ncloud-docs.com/docs/k8s-k8soverview&quot; target=&quot;_blank&quot; style=&quot;word-break:break-all;&quot;&gt;https://guide.ncloud-docs.com/docs/k8s-k8soverview&lt;/a&gt;

2. 클러스터 이용 가이드
	- &lt;a href=&quot;https://guide.ncloud-docs.com/docs/k8s-k8suse-cluster&quot; target=&quot;_blank&quot; style=&quot;word-break:break-all;&quot;&gt;https://guide.ncloud-docs.com/docs/k8s-k8suse-cluster&lt;/a&gt;

3. kubectl 설치 가이드
	- &lt;a href=&quot;https://guide.ncloud-docs.com/docs/k8s-k8sstart#Kubectl%EC%84%A4%EC%B9%98&quot; target=&quot;_blank&quot; style=&quot;word-break:break-all;&quot;&gt;https://guide.ncloud-docs.com/docs/k8s-k8sstart#Kubectl&lt;/a&gt;

4. Windows 환경에서 쿠버네티스 제어하기
	- &lt;a href=&quot;/containers/ncloud-containers-kubernetes-service-start-guide-windows.html&quot; target=&quot;_blank&quot; style=&quot;word-break:break-all;&quot;&gt;https://docs.3rdeyesys.com/containers/ncloud-containers-kubernetes-service-start-guide-windows.html&lt;/a&gt;  	
</description>
            <pubDate>Tue, 16 Aug 2022 00:00:00 +0900</pubDate>
            <link>https://docs.3rdeyesys.com/containers/ncloud-containers-kubernetes-service-start-guide-linux.html</link>
            <guid isPermaLink="true">https://docs.3rdeyesys.com/containers/ncloud-containers-kubernetes-service-start-guide-linux.html</guid>
            
            <category>kubernetes</category>
            
            <category>vpc</category>
            
            
        </item>
        
        <item>
            <title>VPC 환경 Cloud DB for MySQL 읽기 부하를 네트워크 프록시 로드밸런서로 분산시키는 방법</title>
            <description>## 개요
MySQL DB서버의 부하를 줄이기 위해 보통 읽기 전용 DB서버를 생성하게 되는데, 읽기 전용 서버를 여러대 생성해서 로드밸런서(Load Balancer)로 연결하면 읽기 부하를 분산 시키고 좀 더 안정적인 서비스가 가능해집니다.  

여기서는 Ncloud (네이버 클라우드) VPC 환경에서 관리형 DB인 Cloud DB for MySQL의 **읽기 전용 Slave DB를 네트워크 프록시 로드밸런서(Network Proxy Load Balancer)에 연결**하고 제대로 부하가 분산되는지 확인해보겠습니다.

## 사전 준비
DB 접속과 부하 분산을 테스트할 서버가 필요합니다. 여기서는 CentOS 7.8 서버를 준비했습니다.

## DB 서버 생성
우선 [Cloud DB for MySQL] - [DB Server]에서 DB를 생성합니다.

### 서버 설정
DB엔진 버전과 VPC, 그리고 Subnet을 선택합니다.  

[**고가용성 지원**]을 선택하면 [Standby DB]도 추가로 생성되고, [**Multi Zone**]을 선택하면 Master와 Standby Master DB를 각각 [**서로 다른 Zone에 생성**]해서 안정성을 높일 수 있습니다.

{% include image.html file=&quot;database/ncloud-database-cloud-db-for-mysql-read-load-balancing-network-proxy-lb-01.png&quot; width=&quot;845&quot; alt=&quot;cloud VPC 환경에서 Cloud DB for MySQL 서버의 읽기 부하를 네트워크 프록시 로드밸런서로 분산시키는 방법&quot; caption=&quot;&quot; %}

DB 서버 타입, 스토리지 타입, 스토리지 용량, DB 서버 이름, DB 서비스 이름 등을 입력합니다.  
Private Sub 도메인을 선택하고 입력하면 [**\*.{Private Sub Domain}.vpc-cdb.ntruss.com**] 같은 형식으로 도메인이 생성됩니다.

{% include image.html file=&quot;database/ncloud-database-cloud-db-for-mysql-read-load-balancing-network-proxy-lb-02.png&quot; width=&quot;845&quot; alt=&quot;cloud VPC 환경에서 Cloud DB for MySQL 서버의 읽기 부하를 네트워크 프록시 로드밸런서로 분산시키는 방법&quot; caption=&quot;&quot; %}


### DB 설정
USER ID, DB 접근 HOST(IP), USER 암호, 접속 포트, DB명 등을 입력합니다.  
고가용성을 선택한 경우 [Backup]은 기본으로 무조건 사용하게 됩니다.

{% include warning.html title=&quot;접속포트 설정&quot; content=&quot;DB 접속포트는 한번 설정하면 이후에 변경할 수 없으니 신중하게 설정하셔야 합니다.&quot; %}

{% include image.html file=&quot;database/ncloud-database-cloud-db-for-mysql-read-load-balancing-network-proxy-lb-03.png&quot; width=&quot;845&quot; alt=&quot;cloud VPC 환경에서 Cloud DB for MySQL 서버의 읽기 부하를 네트워크 프록시 로드밸런서로 분산시키는 방법&quot; caption=&quot;&quot; %}

## Slave DB Server 추가
DB가 생성되었으면 [Master] DB를 선택하고, [DB 관리]에서 [Slave 추가] 메뉴를 선택합니다.

{% include image.html file=&quot;database/ncloud-database-cloud-db-for-mysql-read-load-balancing-network-proxy-lb-04.png&quot; width=&quot;845&quot; alt=&quot;cloud VPC 환경에서 Cloud DB for MySQL 서버의 읽기 부하를 네트워크 프록시 로드밸런서로 분산시키는 방법&quot; caption=&quot;&quot; %}

Slave DB Server를 추가할 때 설정할 수 있는 것은 Subnet 입니다. 부하 분산을 위해서는 2대 이상을 추가해야 하는데, 여기서는 테스트를 위해 2대를 추가하겠습니다.  
우선 첫번째 Slave DB Server는 KR-2 존에 추가했습니다.

{% include image.html file=&quot;database/ncloud-database-cloud-db-for-mysql-read-load-balancing-network-proxy-lb-05.png&quot; width=&quot;686&quot; alt=&quot;cloud VPC 환경에서 Cloud DB for MySQL 서버의 읽기 부하를 네트워크 프록시 로드밸런서로 분산시키는 방법&quot; caption=&quot;&quot; %}

다음으로 두번째 Slave DB Server는 KR-1 존에 추가해보겠습니다.

{% include image.html file=&quot;database/ncloud-database-cloud-db-for-mysql-read-load-balancing-network-proxy-lb-06.png&quot; width=&quot;686&quot; alt=&quot;cloud VPC 환경에서 Cloud DB for MySQL 서버의 읽기 부하를 네트워크 프록시 로드밸런서로 분산시키는 방법&quot; caption=&quot;&quot; %}

이렇게 Slave DB Server 2대를 추가해서 [Master], [Standy Master] 포함 총 4대의 서버가 생성되었습니다.  

{% include callout_v2.html type=&quot;info&quot; level=&quot;2&quot; content=&quot;[Master] DB 서버와 첫번째 [Slave] DB 서버는 KR-2 존에, &lt;br /&gt;[Standy Master] DB 서버와 두번째 [Slave] DB 서버는 KR-1 존에 생성해서 안정성을 높이는 구조를 선택했습니다.&quot; %}

{% include image.html file=&quot;database/ncloud-database-cloud-db-for-mysql-read-load-balancing-network-proxy-lb-07.png&quot; width=&quot;845&quot; alt=&quot;cloud VPC 환경에서 Cloud DB for MySQL 서버의 읽기 부하를 네트워크 프록시 로드밸런서로 분산시키는 방법&quot; caption=&quot;&quot; %}

## Target Group 설정
다음으로 Load Balancer와 Cloud DB for Mysql을 연결할 Target Group을 설정해보겠습니다.

### Target Group 생성
여기서 중요한 항목은 프로토콜입니다. [Network Proxy Load Balancer]에 사용할 Target Group이므로 [PROXY_TCP]를 선택합니다.  
포트는 Cloud DB for Mysql 생성 시에 사용했던 포트를 입력해야 하는데 여기서는 3306을 사용하겠습니다.

{% include image.html file=&quot;database/ncloud-database-cloud-db-for-mysql-read-load-balancing-network-proxy-lb-08.png&quot; width=&quot;845&quot; alt=&quot;cloud VPC 환경에서 Cloud DB for MySQL 서버의 읽기 부하를 네트워크 프록시 로드밸런서로 분산시키는 방법&quot; caption=&quot;&quot; %}

### Health Check 설정
Health Check 설정에서는 TCP 프로토콜을 선택합니다. 포트는 마찬가지로 3306을 입력합니다.

{% include image.html file=&quot;database/ncloud-database-cloud-db-for-mysql-read-load-balancing-network-proxy-lb-09.png&quot; width=&quot;845&quot; alt=&quot;cloud VPC 환경에서 Cloud DB for MySQL 서버의 읽기 부하를 네트워크 프록시 로드밸런서로 분산시키는 방법&quot; caption=&quot;&quot; %}

### Target 추가
Target 추가 화면에 가면 앞에서 생성했던 Slave DB Server 2대를 확인할 수 있는데, 선택 후에 오른쪽으로 이동시킵니다.

{% include image.html file=&quot;database/ncloud-database-cloud-db-for-mysql-read-load-balancing-network-proxy-lb-10.png&quot; width=&quot;845&quot; alt=&quot;cloud VPC 환경에서 Cloud DB for MySQL 서버의 읽기 부하를 네트워크 프록시 로드밸런서로 분산시키는 방법&quot; caption=&quot;&quot; %}

## Load Balancer 생성
여기서는 [네트워크 프록시 로드밸런서 (Network Proxy Load Balancer)]를 선택합니다.

{% include callout_v2.html type=&quot;warning&quot; level=&quot;3&quot; content=&quot;
**애플리케이션 로드밸런서(Application Load Balancer)**는 Cloud DB for MySQL의 부하분산에 **사용할 수 없습니다**.
&quot; %}

{% include image.html file=&quot;database/ncloud-database-cloud-db-for-mysql-read-load-balancing-network-proxy-lb-11.png&quot; width=&quot;845&quot; alt=&quot;cloud VPC 환경에서 Cloud DB for MySQL 서버의 읽기 부하를 네트워크 프록시 로드밸런서로 분산시키는 방법&quot; caption=&quot;&quot; %}

### 로드밸런서 생성
안정성을 높이려면 로드밸런서도 멀티존으로 구성할 수 있습니다. KR-1, KR-2 두 곳의 서브넷을 모두 선택하겠습니다.

{% include image.html file=&quot;database/ncloud-database-cloud-db-for-mysql-read-load-balancing-network-proxy-lb-12.png&quot; width=&quot;845&quot; alt=&quot;cloud VPC 환경에서 Cloud DB for MySQL 서버의 읽기 부하를 네트워크 프록시 로드밸런서로 분산시키는 방법&quot; caption=&quot;&quot; %}

### 리스너 설정
리스너 프로토콜은 TCP, 포트는 3306으로 설정합니다.

{% include image.html file=&quot;database/ncloud-database-cloud-db-for-mysql-read-load-balancing-network-proxy-lb-13.png&quot; width=&quot;845&quot; alt=&quot;cloud VPC 환경에서 Cloud DB for MySQL 서버의 읽기 부하를 네트워크 프록시 로드밸런서로 분산시키는 방법&quot; caption=&quot;&quot; %}

### Target Group 선택
위에서 생성했던 Target Group을 선택합니다.

{% include image.html file=&quot;database/ncloud-database-cloud-db-for-mysql-read-load-balancing-network-proxy-lb-14.png&quot; width=&quot;845&quot; alt=&quot;cloud VPC 환경에서 Cloud DB for MySQL 서버의 읽기 부하를 네트워크 프록시 로드밸런서로 분산시키는 방법&quot; caption=&quot;&quot; %}

## ACG 설정
[Cloud DB for MySQL]에 접근하는 로드밸런서들의 Subnet 대역을 ACG에 추가해야 합니다.

### Load Balancer 서브넷 확인
ACG에 추가할 멀티존으로 구성된 로드밸런서의 서브넷 2가지를 확인합니다.  
그리고, 테스트 시에 접속할 로드밸런서의 접속 정보를 메모해 둡니다.

{% include image.html file=&quot;database/ncloud-database-cloud-db-for-mysql-read-load-balancing-network-proxy-lb-16.png&quot; width=&quot;845&quot; alt=&quot;cloud VPC 환경에서 Cloud DB for MySQL 서버의 읽기 부하를 네트워크 프록시 로드밸런서로 분산시키는 방법&quot; caption=&quot;&quot; %}

### ACG 확인
[Cloud DB for MySQL]의 [Master] DB를 선택하고 [ACG] 항목 옆의 버튼을 클릭합니다.

{% include image.html file=&quot;database/ncloud-database-cloud-db-for-mysql-read-load-balancing-network-proxy-lb-17.png&quot; width=&quot;845&quot; alt=&quot;cloud VPC 환경에서 Cloud DB for MySQL 서버의 읽기 부하를 네트워크 프록시 로드밸런서로 분산시키는 방법&quot; caption=&quot;&quot; %}

[ACG] 리스트에서 해당 ACG를 선택하고 [ACG 설정] 버튼을 클릭합니다.

{% include image.html file=&quot;database/ncloud-database-cloud-db-for-mysql-read-load-balancing-network-proxy-lb-18.png&quot; width=&quot;845&quot; alt=&quot;cloud VPC 환경에서 Cloud DB for MySQL 서버의 읽기 부하를 네트워크 프록시 로드밸런서로 분산시키는 방법&quot; caption=&quot;&quot; %}

### ACG 규칙 추가
필요한 ACG 규칙을 추가합니다. 
- Load Balancer (KR-1) -&gt; Cloud DB for MySQL 접근 규칙
- Load Balancer (KR-2) -&gt; Cloud DB for MySQL 접근 규칙

{% include image.html file=&quot;database/ncloud-database-cloud-db-for-mysql-read-load-balancing-network-proxy-lb-19.png&quot; width=&quot;845&quot; alt=&quot;cloud VPC 환경에서 Cloud DB for MySQL 서버의 읽기 부하를 네트워크 프록시 로드밸런서로 분산시키는 방법&quot; caption=&quot;&quot; %}

## 테스트 서버 설정
DB 부하 분산 테스트에 사용할 서버에 MySQL Client를 설치합니다.

{% include note.html content=&quot;CentOS 7부터는 yum으로 설치하는 MySQL의 기본 데이터베이스가 MariaDB로 변경되었습니다.&quot; %}

``` bash
~# yum -y install mysql
```
{% include image.html file=&quot;database/ncloud-database-cloud-db-for-mysql-read-load-balancing-network-proxy-lb-20.png&quot; width=&quot;840&quot; alt=&quot;cloud VPC 환경에서 Cloud DB for MySQL 서버의 읽기 부하를 네트워크 프록시 로드밸런서로 분산시키는 방법&quot; caption=&quot;&quot; %}

## 부하 분산 테스트
설치된 MySQL Client를 이용해서 Load Balancer 도메인으로 접속한 후에 접속한 DB 서버의 호스트명을 확인하는 쿼리를 실행합니다.  

여러 차례 반복해보면 아래와 같이 위에서 추가했던 Slave DB [test-003-OOO], [test-004-OOO]에 각각 접속되는 것을 확인할 수 있습니다.

``` bash
~# mysql -h {Load Balancer 접속 도메인} -u {계정} -p
```

``` sql
MySQL [(none)]&gt; SELECT @@hostname;
```

### [test-003-OOO]에 접속된 상태
{% include image.html file=&quot;database/ncloud-database-cloud-db-for-mysql-read-load-balancing-network-proxy-lb-21.png&quot; width=&quot;840&quot; alt=&quot;cloud VPC 환경에서 Cloud DB for MySQL 서버의 읽기 부하를 네트워크 프록시 로드밸런서로 분산시키는 방법&quot; caption=&quot;&quot; %}

### [test-004-OOO]에 접속된 상태
{% include image.html file=&quot;database/ncloud-database-cloud-db-for-mysql-read-load-balancing-network-proxy-lb-22.png&quot; width=&quot;840&quot; alt=&quot;cloud VPC 환경에서 Cloud DB for MySQL 서버의 읽기 부하를 네트워크 프록시 로드밸런서로 분산시키는 방법&quot; caption=&quot;&quot; %}


## DB 삭제
테스트를 끝낸 DB를 삭제하려고 할 때 [Slave나 Recovery DB 서버가 있는 경우 Master DB를 삭제할 수 없습니다.]라는 메시지가 나타나는 것을 확인할 수 있습니다.  

그래서 DB를 삭제할 때는 [Slave DB]부터 삭제해야 하고, [Slave DB]를 삭제할 때에도 동시에 삭제할 수 없고 1대씩 차례로 삭제해야 합니다.

{% include image.html file=&quot;database/ncloud-database-cloud-db-for-mysql-read-load-balancing-15.png&quot; width=&quot;490&quot; alt=&quot;Ncloud Classic 환경에서 Cloud DB for MySQL 디비의 읽기 부하를 로드밸런서로 분산시키는 방법&quot; caption=&quot;&quot; %}


## 참고 URL
1. Ncloud Cloud DB for MySQL 읽기 부하 분산 설정 가이드
	- &lt;a href=&quot;https://guide.ncloud-docs.com/docs/database-database-5-2#%EC%9D%BD%EA%B8%B0-%EB%B6%80%ED%95%98-%EB%B6%84%EC%82%B0-%EC%84%A4%EC%A0%95&quot; target=&quot;_blank&quot; style=&quot;word-break:break-all;&quot;&gt;https://guide.ncloud-docs.com/docs/database-database-5-2&lt;/a&gt;

2. VPC 환경 Cloud DB for MySQL 읽기 부하를 네트워크 로드밸런서로 분산시키는 방법
	- &lt;a href=&quot;/database/ncloud-database-cloud-db-for-mysql-read-load-balancing-network-lb.html&quot; target=&quot;_blank&quot; style=&quot;word-break:break-all;&quot;&gt;https://docs.3rdeyesys.com/database/ncloud-database-cloud-db-for-mysql-read-load-balancing-network-lb.html&lt;/a&gt;    

3. Classic 환경 Cloud DB for MySQL 읽기 부하 로드밸런서로 분산시키는 방법
	- &lt;a href=&quot;/database/ncloud-database-cloud-db-for-mysql-read-load-balancing.html&quot; target=&quot;_blank&quot; style=&quot;word-break:break-all;&quot;&gt;https://docs.3rdeyesys.com/database/ncloud-database-cloud-db-for-mysql-read-load-balancing.html&lt;/a&gt;    	</description>
            <pubDate>Mon, 08 Aug 2022 00:00:00 +0900</pubDate>
            <link>https://docs.3rdeyesys.com/database/ncloud-database-cloud-db-for-mysql-read-load-balancing-network-proxy-lb.html</link>
            <guid isPermaLink="true">https://docs.3rdeyesys.com/database/ncloud-database-cloud-db-for-mysql-read-load-balancing-network-proxy-lb.html</guid>
            
            <category>database</category>
            
            <category>mysql</category>
            
            <category>mariadb</category>
            
            <category>load-balancer</category>
            
            
        </item>
        
        <item>
            <title>VPC 환경 Cloud DB for MySQL 읽기 부하를 네트워크 로드밸런서로 분산시키는 방법</title>
            <description>## 개요
MySQL DB서버의 부하를 줄이기 위해 보통 읽기 전용 DB서버를 생성하게 되는데, 읽기 전용 서버를 여러대 생성해서 로드밸런서(Load Balancer)로 연결하면 읽기 부하를 분산 시키고 좀 더 안정적인 서비스가 가능해집니다.  

여기서는 Ncloud (네이버 클라우드) VPC 환경에서 관리형 DB인 Cloud DB for MySQL의 **읽기 전용 Slave DB를 네트워크 로드밸런서(Network Load Balancer)에 연결**하고 제대로 부하가 분산되는지 확인해보겠습니다.

## 사전 준비
DB 접속과 부하 분산을 테스트할 서버가 필요합니다. 여기서는 CentOS 7.8 서버를 준비했습니다.

## DB 서버 생성
우선 [Cloud DB for MySQL] - [DB Server]에서 DB를 생성합니다.

### 서버 설정
DB엔진 버전과 VPC, 그리고 Subnet을 선택합니다.  

[**고가용성 지원**]을 선택하면 [Standby DB]도 추가로 생성되고, [**Multi Zone**]을 선택하면 Master와 Standby Master DB를 각각 [**서로 다른 Zone에 생성**]해서 안정성을 높일 수 있습니다.

{% include image.html file=&quot;database/ncloud-database-cloud-db-for-mysql-read-load-balancing-network-proxy-lb-01.png&quot; width=&quot;845&quot; alt=&quot;cloud VPC 환경에서 Cloud DB for MySQL 서버의 읽기 부하를 네트워크 로드밸런서로 분산시키는 방법&quot; caption=&quot;&quot; %}

DB 서버 타입, 스토리지 타입, 스토리지 용량, DB 서버 이름, DB 서비스 이름 등을 입력합니다.  
Private Sub 도메인을 선택하고 입력하면 [**\*.{Private Sub Domain}.vpc-cdb.ntruss.com**] 같은 형식으로 도메인이 생성됩니다.

{% include image.html file=&quot;database/ncloud-database-cloud-db-for-mysql-read-load-balancing-network-proxy-lb-02.png&quot; width=&quot;845&quot; alt=&quot;cloud VPC 환경에서 Cloud DB for MySQL 서버의 읽기 부하를 네트워크 로드밸런서로 분산시키는 방법&quot; caption=&quot;&quot; %}


### DB 설정
USER ID, DB 접근 HOST(IP), USER 암호, 접속 포트, DB명 등을 입력합니다.  
고가용성을 선택한 경우 [Backup]은 기본으로 무조건 사용하게 됩니다.

{% include warning.html title=&quot;접속포트 설정&quot; content=&quot;DB 접속포트는 한번 설정하면 이후에 변경할 수 없으니 신중하게 설정하셔야 합니다.&quot; %}

{% include image.html file=&quot;database/ncloud-database-cloud-db-for-mysql-read-load-balancing-network-proxy-lb-03.png&quot; width=&quot;845&quot; alt=&quot;cloud VPC 환경에서 Cloud DB for MySQL 서버의 읽기 부하를 네트워크 로드밸런서로 분산시키는 방법&quot; caption=&quot;&quot; %}

## Slave DB Server 추가
DB가 생성되었으면 [Master] DB를 선택하고, [DB 관리]에서 [Slave 추가] 메뉴를 선택합니다.

{% include image.html file=&quot;database/ncloud-database-cloud-db-for-mysql-read-load-balancing-network-proxy-lb-04.png&quot; width=&quot;845&quot; alt=&quot;cloud VPC 환경에서 Cloud DB for MySQL 서버의 읽기 부하를 네트워크 로드밸런서로 분산시키는 방법&quot; caption=&quot;&quot; %}

Slave DB Server를 추가할 때 설정할 수 있는 것은 Subnet 입니다. 부하 분산을 위해서는 2대 이상을 추가해야 하는데, 여기서는 테스트를 위해 2대를 추가하겠습니다.  
우선 첫번째 Slave DB Server는 KR-2 존에 추가했습니다.

{% include image.html file=&quot;database/ncloud-database-cloud-db-for-mysql-read-load-balancing-network-proxy-lb-05.png&quot; width=&quot;686&quot; alt=&quot;cloud VPC 환경에서 Cloud DB for MySQL 서버의 읽기 부하를 네트워크 로드밸런서로 분산시키는 방법&quot; caption=&quot;&quot; %}

다음으로 두번째 Slave DB Server는 KR-1 존에 추가해보겠습니다.

{% include image.html file=&quot;database/ncloud-database-cloud-db-for-mysql-read-load-balancing-network-proxy-lb-06.png&quot; width=&quot;686&quot; alt=&quot;cloud VPC 환경에서 Cloud DB for MySQL 서버의 읽기 부하를 네트워크 로드밸런서로 분산시키는 방법&quot; caption=&quot;&quot; %}

이렇게 Slave DB Server 2대를 추가해서 [Master], [Standy Master] 포함 총 4대의 서버가 생성되었습니다.  

{% include callout_v2.html type=&quot;info&quot; level=&quot;2&quot; content=&quot;[Master] DB 서버와 첫번째 [Slave] DB 서버는 KR-2 존에, &lt;br /&gt;[Standy Master] DB 서버와 두번째 [Slave] DB 서버는 KR-1 존에 생성해서 안정성을 높이는 구조를 선택했습니다.&quot; %}

{% include image.html file=&quot;database/ncloud-database-cloud-db-for-mysql-read-load-balancing-network-proxy-lb-07.png&quot; width=&quot;845&quot; alt=&quot;cloud VPC 환경에서 Cloud DB for MySQL 서버의 읽기 부하를 네트워크 로드밸런서로 분산시키는 방법&quot; caption=&quot;&quot; %}

## Target Group 설정
다음으로 Load Balancer와 Cloud DB for Mysql을 연결할 Target Group을 설정해보겠습니다.

### Target Group 생성
여기서 중요한 항목은 프로토콜입니다. [Network Load Balancer]에 사용할 Target Group이므로 [TCP]를 선택합니다.  
포트는 Cloud DB for Mysql 생성 시에 사용했던 포트를 입력해야 하는데 여기서는 3306을 사용하겠습니다.

{% include image.html file=&quot;database/ncloud-database-cloud-db-for-mysql-read-load-balancing-network-lb-08.png&quot; width=&quot;845&quot; alt=&quot;cloud VPC 환경에서 Cloud DB for MySQL 서버의 읽기 부하를 네트워크 로드밸런서로 분산시키는 방법&quot; caption=&quot;&quot; %}

### Health Check 설정
Health Check 설정에서는 TCP 프로토콜을 선택합니다. 포트는 마찬가지로 3306을 입력합니다.

{% include image.html file=&quot;database/ncloud-database-cloud-db-for-mysql-read-load-balancing-network-proxy-lb-09.png&quot; width=&quot;845&quot; alt=&quot;cloud VPC 환경에서 Cloud DB for MySQL 서버의 읽기 부하를 네트워크 로드밸런서로 분산시키는 방법&quot; caption=&quot;&quot; %}

### Target 추가
Target 추가 화면에 가면 앞에서 생성했던 Slave DB Server 2대를 확인할 수 있는데, 선택 후에 오른쪽으로 이동시킵니다.

{% include image.html file=&quot;database/ncloud-database-cloud-db-for-mysql-read-load-balancing-network-proxy-lb-10.png&quot; width=&quot;845&quot; alt=&quot;cloud VPC 환경에서 Cloud DB for MySQL 서버의 읽기 부하를 네트워크 로드밸런서로 분산시키는 방법&quot; caption=&quot;&quot; %}

## Load Balancer 생성
여기서는 [네트워크 프록시 로드밸런서 (Network Load Balancer)]를 선택합니다.

{% include callout_v2.html type=&quot;warning&quot; level=&quot;3&quot; content=&quot;
**애플리케이션 로드밸런서(Application Load Balancer)**는 Cloud DB for MySQL의 부하분산에 **사용할 수 없습니다**.
&quot; %}

{% include image.html file=&quot;database/ncloud-database-cloud-db-for-mysql-read-load-balancing-network-lb-11.png&quot; width=&quot;845&quot; alt=&quot;cloud VPC 환경에서 Cloud DB for MySQL 서버의 읽기 부하를 네트워크 로드밸런서로 분산시키는 방법&quot; caption=&quot;&quot; %}

### 로드밸런서 생성
현재 네트워크 로드밸런서는 멀티존으로 구성할 수 없습니다. 그래서 서브넷 선택에서도 1개만 선택할 수 있습니다.

{% include image.html file=&quot;database/ncloud-database-cloud-db-for-mysql-read-load-balancing-network-lb-12.png&quot; width=&quot;845&quot; alt=&quot;cloud VPC 환경에서 Cloud DB for MySQL 서버의 읽기 부하를 네트워크 로드밸런서로 분산시키는 방법&quot; caption=&quot;&quot; %}

### 리스너 설정
리스너 프로토콜은 TCP, 포트는 3306으로 설정합니다.

{% include image.html file=&quot;database/ncloud-database-cloud-db-for-mysql-read-load-balancing-network-proxy-lb-13.png&quot; width=&quot;845&quot; alt=&quot;cloud VPC 환경에서 Cloud DB for MySQL 서버의 읽기 부하를 네트워크 로드밸런서로 분산시키는 방법&quot; caption=&quot;&quot; %}

### Target Group 선택
위에서 생성했던 Target Group을 선택합니다.

{% include image.html file=&quot;database/ncloud-database-cloud-db-for-mysql-read-load-balancing-network-lb-14.png&quot; width=&quot;845&quot; alt=&quot;cloud VPC 환경에서 Cloud DB for MySQL 서버의 읽기 부하를 네트워크 로드밸런서로 분산시키는 방법&quot; caption=&quot;&quot; %}

## ACG 설정
네트워크 로드밸런서와 연동을 할 때는 로드밸런서의 Subnet 대역 뿐만 아니라 [네트워크 로드밸런서]에 접근하는 장비의 공인 IP를 [Cloud DB for MySQL]의 ACG에 추가해야 합니다.

{% include callout_v2.html type=&quot;warning&quot; level=&quot;3&quot; content=&quot;
&amp;#8259; 네트워크 로드밸런서는 보다 고속으로 분산처리를 하기 위해 DSR(Direct Server Return)로 동작합니다. &lt;br /&gt;
&amp;#8259; 그래서 로드밸런서에 접속하는 서버 IP를 Target Group에 묶인 장비(여기서는 DB 서버)에 그대로 전달하게 됩니다. &lt;br /&gt;
&amp;#8259; 그러므로 ACG에는 로드밸런서의 Subnet 대역이 아닌 접속하는 서버의 공인 IP를 허용해 주어야 합니다.
&quot; %}


### Test 서버 공인 IP 확인
테스트를 위해 미리 준비해 둔 CentOS를 설치한 서버입니다. ACG 설정에 추가할 공인 IP를 확인합니다.

{% include image.html file=&quot;database/ncloud-database-cloud-db-for-mysql-read-load-balancing-network-lb-15.png&quot; width=&quot;845&quot; alt=&quot;cloud VPC 환경에서 Cloud DB for MySQL 서버의 읽기 부하를 네트워크 로드밸런서로 분산시키는 방법&quot; caption=&quot;&quot; %}

### Load Balancer 서브넷 확인
ACG에 추가할 멀티존으로 구성된 로드밸런서의 서브넷을 확인합니다.  
그리고, 테스트 시에 접속할 로드밸런서의 접속 정보를 메모해 둡니다.

{% include image.html file=&quot;database/ncloud-database-cloud-db-for-mysql-read-load-balancing-network-lb-16.png&quot; width=&quot;845&quot; alt=&quot;cloud VPC 환경에서 Cloud DB for MySQL 서버의 읽기 부하를 네트워크 로드밸런서로 분산시키는 방법&quot; caption=&quot;&quot; %}


### ACG 확인
[Cloud DB for MySQL]의 [Master] DB를 선택하고 [ACG] 항목 옆의 버튼을 클릭합니다.

{% include image.html file=&quot;database/ncloud-database-cloud-db-for-mysql-read-load-balancing-network-proxy-lb-17.png&quot; width=&quot;845&quot; alt=&quot;cloud VPC 환경에서 Cloud DB for MySQL 서버의 읽기 부하를 네트워크 로드밸런서로 분산시키는 방법&quot; caption=&quot;&quot; %}

[ACG] 리스트에서 해당 ACG를 선택하고 [ACG 설정] 버튼을 클릭합니다.

{% include image.html file=&quot;database/ncloud-database-cloud-db-for-mysql-read-load-balancing-network-proxy-lb-18.png&quot; width=&quot;845&quot; alt=&quot;cloud VPC 환경에서 Cloud DB for MySQL 서버의 읽기 부하를 네트워크 로드밸런서로 분산시키는 방법&quot; caption=&quot;&quot; %}

### ACG 규칙 추가
필요한 ACG 규칙을 추가합니다. 여기서는 테스트에 필요한 다음 항목들을 추가했습니다.
- Test CentOS Server -&gt; Cloud DB for MySQL 접근 규칙
- Load Balancer -&gt; Cloud DB for MySQL 접근 규칙

{% include image.html file=&quot;database/ncloud-database-cloud-db-for-mysql-read-load-balancing-network-lb-19.png&quot; width=&quot;845&quot; alt=&quot;cloud VPC 환경에서 Cloud DB for MySQL 서버의 읽기 부하를 네트워크 로드밸런서로 분산시키는 방법&quot; caption=&quot;&quot; %}

## 테스트 서버 설정
DB 부하 분산 테스트에 사용할 서버에 MySQL Client를 설치합니다.

{% include note.html content=&quot;CentOS 7부터는 yum으로 설치하는 MySQL의 기본 데이터베이스가 MariaDB로 변경되었습니다.&quot; %}

``` bash
~# yum -y install mysql
```
{% include image.html file=&quot;database/ncloud-database-cloud-db-for-mysql-read-load-balancing-network-proxy-lb-20.png&quot; width=&quot;840&quot; alt=&quot;cloud VPC 환경에서 Cloud DB for MySQL 서버의 읽기 부하를 네트워크 로드밸런서로 분산시키는 방법&quot; caption=&quot;&quot; %}

## 부하 분산 테스트
설치된 MySQL Client를 이용해서 Load Balancer 도메인으로 접속한 후에 접속한 DB 서버의 호스트명을 확인하는 쿼리를 실행합니다.  

여러 차례 반복해보면 아래와 같이 위에서 추가했던 Slave DB [test-003-OOO], [test-004-OOO]에 각각 접속되는 것을 확인할 수 있습니다.

``` bash
~# mysql -h {Load Balancer 접속 도메인} -u {계정} -p
```

``` sql
MySQL [(none)]&gt; SELECT @@hostname;
```

### [test-003-OOO]에 접속된 상태
{% include image.html file=&quot;database/ncloud-database-cloud-db-for-mysql-read-load-balancing-network-proxy-lb-21.png&quot; width=&quot;840&quot; alt=&quot;cloud VPC 환경에서 Cloud DB for MySQL 서버의 읽기 부하를 네트워크 로드밸런서로 분산시키는 방법&quot; caption=&quot;&quot; %}

### [test-004-OOO]에 접속된 상태
{% include image.html file=&quot;database/ncloud-database-cloud-db-for-mysql-read-load-balancing-network-proxy-lb-22.png&quot; width=&quot;840&quot; alt=&quot;cloud VPC 환경에서 Cloud DB for MySQL 서버의 읽기 부하를 네트워크 로드밸런서로 분산시키는 방법&quot; caption=&quot;&quot; %}


## DB 삭제
테스트를 끝낸 DB를 삭제하려고 할 때 [Slave나 Recovery DB 서버가 있는 경우 Master DB를 삭제할 수 없습니다.]라는 메시지가 나타나는 것을 확인할 수 있습니다.  

그래서 DB를 삭제할 때는 [Slave DB]부터 삭제해야 하고, [Slave DB]를 삭제할 때에도 동시에 삭제할 수 없고 1대씩 차례로 삭제해야 합니다.

{% include image.html file=&quot;database/ncloud-database-cloud-db-for-mysql-read-load-balancing-15.png&quot; width=&quot;490&quot; alt=&quot;Ncloud Classic 환경에서 Cloud DB for MySQL 디비의 읽기 부하를 로드밸런서로 분산시키는 방법&quot; caption=&quot;&quot; %}


## 참고 URL
1. Ncloud Cloud DB for MySQL 읽기 부하 분산 설정 가이드
	- &lt;a href=&quot;https://guide.ncloud-docs.com/docs/database-database-5-2#%EC%9D%BD%EA%B8%B0-%EB%B6%80%ED%95%98-%EB%B6%84%EC%82%B0-%EC%84%A4%EC%A0%95&quot; target=&quot;_blank&quot; style=&quot;word-break:break-all;&quot;&gt;https://guide.ncloud-docs.com/docs/database-database-5-2&lt;/a&gt;

2. VPC 환경 Cloud DB for MySQL 읽기 부하를 네트워크 프록시 로드밸런서로 분산시키는 방법
	- &lt;a href=&quot;/database/ncloud-database-cloud-db-for-mysql-read-load-balancing-network-proxy-lb.html&quot; target=&quot;_blank&quot; style=&quot;word-break:break-all;&quot;&gt;https://docs.3rdeyesys.com/database/ncloud-database-cloud-db-for-mysql-read-load-balancing-network-proxy-lb.html&lt;/a&gt;    

3. Classic 환경 Cloud DB for MySQL 읽기 부하 로드밸런서로 분산시키는 방법
	- &lt;a href=&quot;/database/ncloud-database-cloud-db-for-mysql-read-load-balancing.html&quot; target=&quot;_blank&quot; style=&quot;word-break:break-all;&quot;&gt;https://docs.3rdeyesys.com/database/ncloud-database-cloud-db-for-mysql-read-load-balancing.html&lt;/a&gt;        </description>
            <pubDate>Mon, 08 Aug 2022 00:00:00 +0900</pubDate>
            <link>https://docs.3rdeyesys.com/database/ncloud-database-cloud-db-for-mysql-read-load-balancing-network-lb.html</link>
            <guid isPermaLink="true">https://docs.3rdeyesys.com/database/ncloud-database-cloud-db-for-mysql-read-load-balancing-network-lb.html</guid>
            
            <category>database</category>
            
            <category>mysql</category>
            
            <category>mariadb</category>
            
            <category>load-balancer</category>
            
            
        </item>
        
        <item>
            <title>Proxy Protocol을 이용해 Client IP 확인하기 | CentOS</title>
            <description>## 개요
Ncloud Load Balancer는 HTTP, HTTPS, TCP, SSL 이렇게 4가지의 프로토콜을 지원합니다.  
그런데, Load Balancer를 사용하면서 Client IP를 확인하려고 할 때 http, https 통신의 경우 X-Forwarded-For 헤더값이 지원되기에 Client IP를 확인할 수 있지만, 
TCP 통신의 경우 X-Forwarded-For 헤더를 사용할 수 없기에 Client IP를 확인하기 위해서는 Proxy Protocol 옵션을 활성화 시켜야 합니다.

여기서는 **Ncloud Network Proxy Load Balancer**의 TCP 프로토콜을 사용하면서 `Proxy Protocol 옵션을 활성화`시켜 **CentOS 서버에서 Client IP를 기록**하는 방법을 소개하겠습니다.

## 테스트 환경
- VPC 환경
- CentOS 7.8
- Apache 2.4.6
- Network Proxy Load Balancer
- Protocol/Port: TCP/80


## CentOS 서버 설치
서버를 생성하고 Apache 웹서버와 개발용 추가 모듈이 포함된 **httpd-devel 패키지**를 설치하고 간단한 웹페이지를 만들어 접속해 보았습니다.  

- VPC 환경에서 서버 생성하는 방법 : &lt;a href=&quot;/compute/ncloud_compute_server_vpc_create.html&quot; target=&quot;_blank&quot; style=&quot;word-break:break-all;&quot;&gt;https://docs.3rdeyesys.com/compute/ncloud_compute_server_vpc_create.html&lt;/a&gt;

```bash
~# yum -y install httpd httpd-devel
```
{% include image.html file=&quot;networking/ncloud-networking-proxy-protocol-client-ip-logging-01.png&quot; width=&quot;845&quot; alt=&quot;Ncloud Network Proxy Load Balancer에서 Proxy Protocol을 이용해 클라이언트 IP 주소를 확인하는 방법&quot; caption=&quot;&quot; %}

## Target Group 설정 
우선 Load Balancer를 생성하기 전에 Load Balancer에서 사용할 Target Group을 [Load Balancer] - [Target Group]에서 생성합니다.

### Target Group 생성
Target Group의 이름를 입력하고 Target 유형은 [VPC Server]를 선택, 다음으로 VPC 대역을 선택합니다.  
그리고, `프로토콜은 PROXY_TCP를 선택`하고, 포트는 80포트를 사용하겠습니다.

{% include image.html file=&quot;networking/ncloud-networking-proxy-protocol-client-ip-logging-03.png&quot; width=&quot;845&quot; alt=&quot;Ncloud Network Proxy Load Balancer에서 Proxy Protocol을 이용해 클라이언트 IP 주소를 확인하는 방법&quot; caption=&quot;&quot; %}

### Health Check 설정
Health Check 할 프로토콜은 TCP를 선택합니다.

{% include image.html file=&quot;networking/ncloud-networking-proxy-protocol-client-ip-logging-04.png&quot; width=&quot;845&quot; alt=&quot;Ncloud Network Proxy Load Balancer에서 Proxy Protocol을 이용해 클라이언트 IP 주소를 확인하는 방법&quot; caption=&quot;&quot; %}

### Target 추가
앞에서 생성했던 서버 2대를 선택하고 [적용 Target]쪽으로 이동시킵니다.

{% include image.html file=&quot;networking/ncloud-networking-proxy-protocol-client-ip-logging-05.png&quot; width=&quot;845&quot; alt=&quot;Ncloud Network Proxy Load Balancer에서 Proxy Protocol을 이용해 클라이언트 IP 주소를 확인하는 방법&quot; caption=&quot;&quot; %}

### 설정 확인
설정 정보를 최종 확인하고 이상이 없으면 Target Group을 생성합니다.

{% include image.html file=&quot;networking/ncloud-networking-proxy-protocol-client-ip-logging-06.png&quot; width=&quot;845&quot; alt=&quot;Ncloud Network Proxy Load Balancer에서 Proxy Protocol을 이용해 클라이언트 IP 주소를 확인하는 방법&quot; caption=&quot;&quot; %}

생성된 Target Group를 확인할 수 있습니다.
{% include image.html file=&quot;networking/ncloud-networking-proxy-protocol-client-ip-logging-07.png&quot; width=&quot;845&quot; alt=&quot;Ncloud Network Proxy Load Balancer에서 Proxy Protocol을 이용해 클라이언트 IP 주소를 확인하는 방법&quot; caption=&quot;&quot; %}

## Network Proxy Load Balancer 생성
[Load Balancer]에서 [로드밸런서 생성] 버튼을 클릭하고  [네트워크 프록시 로드밸런서]를 선택합니다.

{% include image.html file=&quot;networking/ncloud-networking-proxy-protocol-client-ip-logging-08.png&quot; width=&quot;845&quot; alt=&quot;Ncloud Network Proxy Load Balancer에서 Proxy Protocol을 이용해 클라이언트 IP 주소를 확인하는 방법&quot; caption=&quot;&quot; %}

### 로드밸런서 설정
필요한 로드밸런서 설정을 선택하는데, 그 중에서 서브넷은 혹시 생성되어 있지 않으면 [서브넷 생성] 버튼을 클릭해 로드밸런서 전용 서브넷을 생성한 후에 다시 돌아옵니다. 여기서는 [10.0.4.0/24] 대역으로 설정했습니다.

{% include image.html file=&quot;networking/ncloud-networking-proxy-protocol-client-ip-logging-09.png&quot; width=&quot;845&quot; alt=&quot;Ncloud Network Proxy Load Balancer에서 
Proxy Protocol을 이용해 클라이언트 IP 주소를 확인하는 방법&quot; caption=&quot;&quot; %}

### 리스너 설정
리스너는 TCP 프로토콜에 80 포트를 선택하고 추가합니다.

{% include image.html file=&quot;networking/ncloud-networking-proxy-protocol-client-ip-logging-10.png&quot; width=&quot;845&quot; alt=&quot;Ncloud Network Proxy Load Balancer에서 
Proxy Protocol을 이용해 클라이언트 IP 주소를 확인하는 방법&quot; caption=&quot;&quot; %}

### Target Group 선택
Target Group는 위쪽에서 생성한 [Proxy-Protocol-TG] 을 선택합니다. 선택하면 해당 Target Group 설정 내용을 바로 확인할 수 있습니다.

{% include image.html file=&quot;networking/ncloud-networking-proxy-protocol-client-ip-logging-11.png&quot; width=&quot;845&quot; alt=&quot;Ncloud Network Proxy Load Balancer에서 
Proxy Protocol을 이용해 클라이언트 IP 주소를 확인하는 방법&quot; caption=&quot;&quot; %}

### 설정 확인
선택한 설정을 최종 확인하고 이상이 없으면 [로드밸런서 생성] 버튼을 클릭합니다.

{% include image.html file=&quot;networking/ncloud-networking-proxy-protocol-client-ip-logging-12.png&quot; width=&quot;845&quot; alt=&quot;Ncloud Network Proxy Load Balancer에서 
Proxy Protocol을 이용해 클라이언트 IP 주소를 확인하는 방법&quot; caption=&quot;&quot; %}

### 생성 확인
생성된 로드밸런서의 정보를 확인합니다. 특히 접속 정보와 서브넷은 이후 테스트에 사용되므로 꼭 기억하거나 메모해 두는 것이 좋습니다.

{% include image.html file=&quot;networking/ncloud-networking-proxy-protocol-client-ip-logging-13.png&quot; width=&quot;845&quot; alt=&quot;Ncloud Network Proxy Load Balancer에서 
Proxy Protocol을 이용해 클라이언트 IP 주소를 확인하는 방법&quot; caption=&quot;&quot; %}

## ACG 설정
로드밸런서 → 서버 접속이 가능하도록 서버 ACG에 규칙을 추가합니다.  
서버에 적용된 ACG의 규칙 설정 화면에서 프로토콜은 TCP,  접근소스는 로드밸런서 IP 대역인 10.0.4.0/24, 포트는 80을 입력하고 추가합니다.

{% include image.html file=&quot;networking/ncloud-networking-proxy-protocol-client-ip-logging-32.png&quot; width=&quot;845&quot; alt=&quot;Ncloud Network Proxy Load Balancer에서 
Proxy Protocol을 이용해 클라이언트 IP 주소를 확인하는 방법&quot; caption=&quot;&quot; %}

## 로드밸런서 접속 테스트
위에서 생성된 로드밸런서 접속 주소로 접속을 해보면 아래와 같은 화면을 확인할 수 있습니다.

{% include image.html file=&quot;networking/ncloud-networking-proxy-protocol-client-ip-logging-14.png&quot; width=&quot;845&quot; alt=&quot;Ncloud Network Proxy Load Balancer에서 
Proxy Protocol을 이용해 클라이언트 IP 주소를 확인하는 방법&quot; caption=&quot;&quot; %}

### Apache 접속 로그 확인
Apache 접속 로그 파일은 아래의 위치에 존재하지만, 저희는 네이버 클라우드 (Ncloud)의 상품 중 하나인 **Cloud Log Analytics**에서 로그를 수집해서 확인해보겠습니다. 
- CentOS Apache 로그파일 위치 : /var/log/httpd/access_log

- Cloud Log Analytics 설정 가이드 : &lt;a href=&quot;/analytics/ncloud_analytics_cloud_log_analytics_guide.html&quot; target=&quot;_blank&quot; style=&quot;word-break:break-all;&quot;&gt;https://docs.3rdeyesys.com/analytics/ncloud_analytics_cloud_log_analytics_guide.html&lt;/a&gt;

Cloud Log Analytics에서 수집한 로그를 확인해보면 위에서 설정했던 **Load Balancer의 IP 대역 (10.0.4.xx)**이 기록된 것을 확인할 수 있습니다.  

다음에는 로드밸런서 IP가 아닌 실제 Client IP가 기록되도록 설정을 변경해 보겠습니다.

{% include image.html file=&quot;networking/ncloud-networking-proxy-protocol-client-ip-logging-16-1.png&quot; width=&quot;845&quot; alt=&quot;Ncloud Network Proxy Load Balancer에서 
Proxy Protocol을 이용해 클라이언트 IP 주소를 확인하는 방법&quot; caption=&quot;&quot; %}


## Proxy Protocol 설정
이제 실제 Client IP가 기록되도록 Proxy Protocol을 설정해보겠습니다.  
[Load Balancer] - [Target Group]에서 위에서 생성했던 Target Group를 선택하고 [TargetGroup 설정] 버튼을 클릭합니다.

{% include image.html file=&quot;networking/ncloud-networking-proxy-protocol-client-ip-logging-17.png&quot; width=&quot;845&quot; alt=&quot;Ncloud Network Proxy Load Balancer에서 
Proxy Protocol을 이용해 클라이언트 IP 주소를 확인하는 방법&quot; caption=&quot;&quot; %}

Target Group 설정 화면에서 [ProxyProtocol] 옵션을 체크하고 확인 버튼을 클릭합니다.

{% include image.html file=&quot;networking/ncloud-networking-proxy-protocol-client-ip-logging-18.png&quot; width=&quot;680&quot; alt=&quot;Ncloud Network Proxy Load Balancer에서 
Proxy Protocol을 이용해 클라이언트 IP 주소를 확인하는 방법&quot; caption=&quot;&quot; %}

위에서 정상적으로 접속이 되었던 로드밸런서 주소로 접속하면 [Bad Request] 메시지가 뜨는 것을 확인할 수 있습니다.  
다음으로는 서버 설정을 변경해야 합니다.

{% include image.html file=&quot;networking/ncloud-networking-proxy-protocol-client-ip-logging-19.png&quot; width=&quot;845&quot; alt=&quot;Ncloud Network Proxy Load Balancer에서 
Proxy Protocol을 이용해 클라이언트 IP 주소를 확인하는 방법&quot; caption=&quot;&quot; %}

## Apache 모듈 설치
Proxy Protocol을 사용할 때 필요한 Apache 모듈을 CentOS 서버에 설치하겠습니다.

### mod_myfixip 모듈 다운로드
아래 명령어로 mod_myfixip.c 파일을 다운로드 받습니다. 정상적으로 다운로드가 완료되면 **&apos;mod_myfixip.c&apos; saved** 라는 메시지를 확인할 수 있습니다.

```bash
~# wget --no-check-certificate https://raw.githubusercontent.com/ggrandes/apache24-modules/master/mod_myfixip.c
```

{% include image.html file=&quot;networking/ncloud-networking-proxy-protocol-client-ip-logging-20.png&quot; width=&quot;840&quot; alt=&quot;Ncloud Network Proxy Load Balancer에서 
Proxy Protocol을 이용해 클라이언트 IP 주소를 확인하는 방법&quot; caption=&quot;&quot; %}

### 모듈 설치
이어서 /{아파치가 설치된 경로}/bin/apxs -c -i mod_myfixip.c 명령어로 모듈을 설치합니다.

```bash
~# /usr/bin/apxs -c -i mod_myfixip.c
```
{% include image.html file=&quot;networking/ncloud-networking-proxy-protocol-client-ip-logging-21.png&quot; width=&quot;840&quot; alt=&quot;Ncloud Network Proxy Load Balancer에서 
Proxy Protocol을 이용해 클라이언트 IP 주소를 확인하는 방법&quot; caption=&quot;&quot; %}

### httpd.conf 설정 변경
모듈 설치가 완료된 후에 httpd.conf 파일을 열어서 제일 아래쪽에 아래 코드를 추가합니다.  
RewriteIPAllow 항목에는 로드밸런서 IP 대역 (ex: 192.168.0.0/16, 10.31.0.0/16 등)을 입력합니다.  
여기서는 위에서 설정했던 로드밸런서 IP 대역인 `10.0.4.0/24`를 입력했습니다. 

``` bash
~# vi /etc/httpd/conf/httpd.conf
```
``` apache
LoadModule myfixip_module modules/mod_myfixip.so

&lt;IfModule mod_myfixip.c&gt;
  RewriteIPResetHeader off
  RewriteIPAllow 10.0.4.0/24
&lt;/IfModule&gt;
```

{% include image.html file=&quot;networking/ncloud-networking-proxy-protocol-client-ip-logging-22.png&quot; width=&quot;840&quot; alt=&quot;Ncloud Network Proxy Load Balancer에서 
Proxy Protocol을 이용해 클라이언트 IP 주소를 확인하는 방법&quot; caption=&quot;&quot; %}

### Apache 재시작
설정을 마친 후에 Apache를 재시작합니다.

``` bash
~# systemctl restart httpd
```
{% include image.html file=&quot;networking/ncloud-networking-proxy-protocol-client-ip-logging-23.png&quot; width=&quot;840&quot; alt=&quot;Ncloud Network Proxy Load Balancer에서 
Proxy Protocol을 이용해 클라이언트 IP 주소를 확인하는 방법&quot; caption=&quot;&quot; %}


## 최종 접속 테스트
모든 설정을 모두 마친 후에 서버에 접속해봅니다.

{% include image.html file=&quot;networking/ncloud-networking-proxy-protocol-client-ip-logging-14.png&quot; width=&quot;845&quot; alt=&quot;Ncloud Network Proxy Load Balancer에서 
Proxy Protocol을 이용해 클라이언트 IP 주소를 확인하는 방법&quot; caption=&quot;&quot; %}

## 최종 접속 로그 확인
접속 로그를 다시 확인해보면 이번에는 로드밸런서 IP가 아닌 Client IP가 기록된 것을 확인할 수 있습니다.

{% include image.html file=&quot;networking/ncloud-networking-proxy-protocol-client-ip-logging-29-1.png&quot; width=&quot;845&quot; alt=&quot;Ncloud Network Proxy Load Balancer에서 
Proxy Protocol을 이용해 클라이언트 IP 주소를 확인하는 방법&quot; caption=&quot;&quot; %}

## 참고 URL

1. Proxy Protocol 설정하기
  - &lt;a href=&quot;https://guide.ncloud-docs.com/docs/networking-loadbalancer-targetgroupconsole#proxy-protocol-%EC%84%A4%EC%A0%95%ED%95%98%EA%B8%B0&quot; target=&quot;_blank&quot; style=&quot;word-break:break-all;&quot;&gt;https://guide.ncloud-docs.com/docs/networking-loadbalancer-targetgroupconsole#proxy-protocol&lt;/a&gt;

2. Ubuntu 서버에서 Proxy Protocol을 이용해 Client IP 확인하기
  - &lt;a href=&quot;/networking/ncloud-networking-proxy-protocol-client-ip-logging-ubuntu.html&quot; target=&quot;_blank&quot; style=&quot;word-break:break-all;&quot;&gt;https://docs.3rdeyesys.com/networking/ncloud-networking-proxy-protocol-client-ip-logging-ubuntu.html&lt;/a&gt;


</description>
            <pubDate>Thu, 04 Aug 2022 00:00:00 +0900</pubDate>
            <link>https://docs.3rdeyesys.com/networking/ncloud-networking-proxy-protocol-client-ip-logging-centos.html</link>
            <guid isPermaLink="true">https://docs.3rdeyesys.com/networking/ncloud-networking-proxy-protocol-client-ip-logging-centos.html</guid>
            
            <category>vpc</category>
            
            <category>load_balancer</category>
            
            <category>proxy</category>
            
            
        </item>
        
        <item>
            <title>VPC 환경에서 Application Load Balancer 생성하기</title>
            <description>## 개요
네이버 클라우드 VPC 환경의 대표적인 Load Balancer인 Application Load Balancer 를 생성하는 가이드입니다.  
VPC와 Subnet을 생성하고, 테스트를 위한 서버 2대를 CentOS와 Ubuntu 각각 1대씩 준비해서 Application Load Balancer와 연결하고 접속해보는 과정까지 정리해보겠습니다.

## VPC 생성
VPC 환경에서는 먼저 VPC를 먼저 생성해야 하며, 이미 만들어진 VPC가 있다면 그대로 이용하셔도 됩니다.  
VPC의 IP 주소 범위는 private 대역 (10.0.0.0/8, 172.160.0./12, 192.168.0.0/16) 내에서 /16 ~ /28 범위여야 합니다.  
여기서는 192.168.0.0/16 범위의 VPC를 생성하겠습니다.

{% include image.html file=&quot;networking/ncp_networking_load_balancer_application_01.jpg&quot; width=&quot;770&quot; alt=&quot;Ncloud VPC 환경에서 Application Load Balancer 생성하기 가이드&quot; caption=&quot;&quot; %}

## Subnet 생성
Load Balancer를 생성할 때 Server와는 다른 Subnet을 사용해야 정상 작동합니다.  
그래서 여기서도 Load Balancer용 Subnet과 테스트 Server용 Subnet을 각각 생성하도록 하겠습니다.

### Load Balancer용 Subnet 생성
Load Balancer는 Private Subnet에 위치해야 하므로 192.168.1.0/24 IP 대역에 Internet Gateway 전용 여부 옵션은 N (Private)을 선택합니다.

{% include image.html file=&quot;networking/ncp_networking_load_balancer_application_02.jpg&quot; width=&quot;770&quot; alt=&quot;Ncloud VPC 환경에서 Application Load Balancer 생성하기 가이드&quot; caption=&quot;&quot; %}


### Server용 Subnet 생성
일반 서버용 Subnet은 192.168.2.0/24 IP 대역에 Internet Gateway 전용 여부 옵션은 Y (Public)을 선택합니다.

{% include image.html file=&quot;networking/ncp_networking_load_balancer_application_03.jpg&quot; width=&quot;770&quot; alt=&quot;Ncloud VPC 환경에서 Application Load Balancer 생성하기 가이드&quot; caption=&quot;&quot; %}

## 테스트용 Server 생성
테스트를 위한 서버는 위에서 생성했던 192.168.2.0/24 IP 대역의 Subnet을 선택하고 Network Interface도 동일한 Subnet을 선택합니다.  
Load Balancer를 테스트 하기 위한 서버이므로 2대를 생성하면서 1대는 CentOS, 나머지 1대는 Ubunt로 생성하겠습니다.

{% include image.html file=&quot;networking/ncp_networking_load_balancer_application_04.jpg&quot; width=&quot;850&quot; alt=&quot;Ncloud VPC 환경에서 Application Load Balancer 생성하기 가이드&quot; caption=&quot;&quot; %}

## Target Group 생성
[VPC] - [Load Balancer] - [Target Group]에서 Load Balancer가 바라보게 될 Target Group를 설정합니다.  
여기서는 HTTP 프로토콜과 80 포트를 선택하겠습니다.

{% include image.html file=&quot;networking/ncp_networking_load_balancer_application_05.jpg&quot; width=&quot;770&quot; alt=&quot;Ncloud VPC 환경에서 Application Load Balancer 생성하기 가이드&quot; caption=&quot;&quot; %}

다음으로 Health Check 설정에서는 HTTP, 80포트, HEAD Method를 선택합니다.

{% include image.html file=&quot;networking/ncp_networking_load_balancer_application_06.jpg&quot; width=&quot;770&quot; alt=&quot;Ncloud VPC 환경에서 Application Load Balancer 생성하기 가이드&quot; caption=&quot;&quot; %}

마지막으로 Target 즉, 대상이 되는 서버 2대 (lb-test-ubuntu, lb-test-centos)를 선택하고, 적용 Target쪽으로 이동시키는 버튼을 클릭합니다.

{% include image.html file=&quot;networking/ncp_networking_load_balancer_application_07.jpg&quot; width=&quot;810&quot; alt=&quot;Ncloud VPC 환경에서 Application Load Balancer 생성하기 가이드&quot; caption=&quot;&quot; %}

대상 서버들이 적용 Target으로 설정된 모습입니다. 이후에는 전체 설정을 다시 확인하고 생성 완료를 하면 됩니다.

{% include image.html file=&quot;networking/ncp_networking_load_balancer_application_08.jpg&quot; width=&quot;810&quot; alt=&quot;Ncloud VPC 환경에서 Application Load Balancer 생성하기 가이드&quot; caption=&quot;&quot; %}


## Load Balancer 생성
네이버 클라우드 VPC 환경에서 제공하는 Load Balancer는 애플리케이션 로드밸런서, 네트워크 로드밸런서, 네트워크 프록시 로드밸런서 이렇게 3가지가 있습니다.  
그 중에서 가장 많이 사용하는 HTTP, HTTPS 트래픽을 사용하는 웹 애플리케이션용 Application Load Balancer를 생성하겠습니다.

{% include image.html file=&quot;networking/ncp_networking_load_balancer_application_09.jpg&quot; width=&quot;770&quot; alt=&quot;Ncloud VPC 환경에서 Application Load Balancer 생성하기 가이드&quot; caption=&quot;&quot; %}

Network는 Public IP, Subnet은 앞에서 생성했던 192.168.1.0/24 대역의 Subnet을 선택합니다.

{% include image.html file=&quot;networking/ncp_networking_load_balancer_application_10.jpg&quot; width=&quot;770&quot; alt=&quot;Ncloud VPC 환경에서 Application Load Balancer 생성하기 가이드&quot; caption=&quot;&quot; %}

리스너 설정에서 프로토콜은 HTTP, 포트는 80을 선택하고 [추가] 버튼을 클릭합니다.

{% include image.html file=&quot;networking/ncp_networking_load_balancer_application_11.jpg&quot; width=&quot;770&quot; alt=&quot;Ncloud VPC 환경에서 Application Load Balancer 생성하기 가이드&quot; caption=&quot;&quot; %}

Target Group은 앞에서 생성했던 test-tg을 선택하면, 아래에 해당 Target Group의 설정이 표시됩니다.  
다음으로 전체 설정을 다시 확인하고 최종 생성하기 버튼을 클릭하면 Load Balancer가 생성됩니다.

{% include image.html file=&quot;networking/ncp_networking_load_balancer_application_12.jpg&quot; width=&quot;770&quot; alt=&quot;Ncloud VPC 환경에서 Application Load Balancer 생성하기 가이드&quot; caption=&quot;&quot; %}

## ACG 설정
Load Balancer가 정상 작동하기 위해서는 [Server] - [ACG]에서 [Inbound 규칙]에 Load Balancer용 Subnet 대역인 192.168.1.0/24 대역의 80 포트를 허용포트로 설정해 줍니다.

{% include image.html file=&quot;networking/ncp_networking_load_balancer_application_14.jpg&quot; width=&quot;770&quot; alt=&quot;Ncloud VPC 환경에서 Application Load Balancer 생성하기 가이드&quot; caption=&quot;&quot; %}

## Server 웹서버 설정
Application Load Balancer를 테스트 하기 위해서는 테스트 Server에 웹서버가 설정되어 있어야 하는데, 네이버 클라우드 VPC 환경에서는 LAMP, LEMP 등의 웹서버가 설정된 이미지를 제공하지 않습니다.  
그래서 기본 OS만 설치된 서버에 Apache 웹서버와 php를 설치하도록 하겠습니다. 설치 작업은 아래와 같이 Ubuntu와 CentOS 각각 스크립트를 만들어서 한번에 설치하는 방법을 사용했는데, 필요에 따라서는 하나씩 별도로 설치하셔도 됩니다.

### Ubuntu에 Apache, PHP 설치하기 스크립트
Apache와 PHP를 설치하고 기본문서 index.html에 서버의 호스트명을 출력하는 스크립트를 적용합니다.

사용한 OS는 Ubuntu 16.04 입니다.

``` bash
#!/bin/bash

apt update
apt install apache2 
apt install php
apt install libapache2-mod-php

systemctl start apache2

cd /var/www/html
echo &quot;&lt;?php&quot; &gt; index.html
echo &quot;echo \&quot;Your server name is \&quot;.(gethostname()).\&quot;&lt;br&gt;\&quot;;&quot; &gt;&gt; index.html
echo &quot;?&gt;&quot; &gt;&gt; index.html

echo AddType application/x-httpd-php .php .php3 .php4 .php5 .html .htm .inc &gt;&gt; phpadd
cat phpadd &gt;&gt; /etc/apache2/apache2.conf

systemctl restart apache2
systemctl enable apache2
systemctl status apache2
```
&lt;br /&gt;

### CentOS에 Apache, PHP 설치하기 스크립트
사용한 OS는 CentOS 7.3 입니다.

``` bash
#!/bin/bash

yum -y install httpd php

systemctl start httpd

cd /var/www/html
echo &quot;&lt;?php&quot; &gt; index.html
echo &quot;echo \&quot;Your server name is \&quot;.(gethostname()).\&quot;&lt;br&gt;\&quot;;&quot; &gt;&gt; index.html
echo &quot;?&gt;&quot; &gt;&gt; index.html

echo AddType application/x-httpd-php .php .php3 .php4 .php5 .html .htm .inc &gt;&gt; phpadd
cat phpadd &gt;&gt; /etc/httpd/conf/httpd.conf

systemctl restart httpd
systemctl enable httpd
systemctl status httpd
```

## 접속 테스트
앞에서 생성했던 Load Balancer 정보에서 접속 정보용 주소를 확인하고 복사합니다.

{% include image.html file=&quot;networking/ncp_networking_load_balancer_application_16.jpg&quot; width=&quot;770&quot; alt=&quot;Ncloud VPC 환경에서 Application Load Balancer 생성하기 가이드&quot; caption=&quot;&quot; %}

복사한 Load Balancer 주소를 웹브라우저에 입력하고 계속 새로 고침을 해보면 아래와 같이 CentOS 서버와 Ubuntu에 접속될 때 마다 해당 서버의 호스트명이 출력되면서 Load Balancer가 정상 작동하는 것을 확인할 수 있습니다.

{% include image.html file=&quot;networking/ncp_networking_load_balancer_application_15-1.jpg&quot; width=&quot;560&quot; alt=&quot;Ncloud VPC 환경에서 Application Load Balancer 생성하기 가이드&quot; caption=&quot;&quot; %}

{% include image.html file=&quot;networking/ncp_networking_load_balancer_application_15-2.jpg&quot; width=&quot;560&quot; alt=&quot;Ncloud VPC 환경에서 Application Load Balancer 생성하기 가이드&quot; caption=&quot;&quot; %}


## 참고 URL
1. Application Load Balancer 가이드
	- &lt;a href=&quot;https://guide.ncloud-docs.com/docs/networking-loadbalancer-applicationlbconsole&quot; target=&quot;_blank&quot; style=&quot;word-break:break-all;&quot;&gt;https://guide.ncloud-docs.com/docs/networking-loadbalancer-applicationlbconsole&lt;/a&gt;

2. Target Group 가이드
	- &lt;a href=&quot;https://guide.ncloud-docs.com/docs/networking-loadbalancer-targetgroupconsole&quot; target=&quot;_blank&quot; style=&quot;word-break:break-all;&quot;&gt;https://guide.ncloud-docs.com/docs/networking-loadbalancer-targetgroupconsole&lt;/a&gt;
</description>
            <pubDate>Thu, 04 Aug 2022 00:00:00 +0900</pubDate>
            <link>https://docs.3rdeyesys.com/networking/ncloud_networking_load_balancer_application_lb.html</link>
            <guid isPermaLink="true">https://docs.3rdeyesys.com/networking/ncloud_networking_load_balancer_application_lb.html</guid>
            
            <category>vpc</category>
            
            <category>load_balancer</category>
            
            
        </item>
        
        <item>
            <title>Proxy Protocol을 이용해 Client IP 확인하기 | Ubuntu</title>
            <description>## 개요
Ncloud Load Balancer는 HTTP, HTTPS, TCP, SSL 이렇게 4가지의 프로토콜을 지원합니다.  
그런데, Load Balancer를 사용하면서 Client IP를 확인하려고 할 때 http, https 통신의 경우 X-Forwarded-For 헤더값이 지원되기에 Client IP를 확인할 수 있지만, 
TCP 통신의 경우 X-Forwarded-For 헤더를 사용할 수 없기에 Client IP를 확인하기 위해서는 Proxy Protocol 옵션을 활성화 시켜야 합니다.

여기서는 **Ncloud Network Proxy Load Balancer**의 TCP 프로토콜을 사용하면서 `Proxy Protocol 옵션을 활성화`시켜 **Ubuntu 서버에서 Client IP를 기록**하는 방법을 소개하겠습니다.

## 테스트 환경
- VPC 환경
- Ubuntu 18.04
- Apache 2.4.6
- Network Proxy Load Balancer
- Protocol/Port: TCP/80


## Ubuntu 서버 설치
서버를 생성하고 Apache 웹서버와 개발용 추가 모듈이 포함된 **apache2-dev 패키지**를 설치하고 간단한 웹페이지를 만들어 접속해 보았습니다.  

- VPC 환경에서 서버 생성하는 방법 : &lt;a href=&quot;/compute/ncloud_compute_server_vpc_create.html&quot; target=&quot;_blank&quot; style=&quot;word-break:break-all;&quot;&gt;https://docs.3rdeyesys.com/compute/ncloud_compute_server_vpc_create.html&lt;/a&gt;

``` bash
~# apt update
~# apt -y install apache2 apache2-dev
```
{% include image.html file=&quot;networking/ncloud-networking-proxy-protocol-client-ip-logging-02.png&quot; width=&quot;845&quot; alt=&quot;Ncloud Network Proxy Load Balancer에서 Proxy Protocol을 이용해 클라이언트 IP 주소를 확인하는 방법&quot; caption=&quot;&quot; %}


## Target Group 설정 
우선 Load Balancer를 생성하기 전에 Load Balancer에서 사용할 Target Group을 [Load Balancer] - [Target Group]에서 생성합니다.

### Target Group 생성
Target Group의 이름를 입력하고 Target 유형은 [VPC Server]를 선택, 다음으로 VPC 대역을 선택합니다.  
그리고, `프로토콜은 PROXY_TCP를 선택`하고, 포트는 80포트를 사용하겠습니다.

{% include image.html file=&quot;networking/ncloud-networking-proxy-protocol-client-ip-logging-03.png&quot; width=&quot;845&quot; alt=&quot;Ncloud Network Proxy Load Balancer에서 Proxy Protocol을 이용해 클라이언트 IP 주소를 확인하는 방법&quot; caption=&quot;&quot; %}

### Health Check 설정
Health Check 할 프로토콜은 TCP를 선택합니다.

{% include image.html file=&quot;networking/ncloud-networking-proxy-protocol-client-ip-logging-04.png&quot; width=&quot;845&quot; alt=&quot;Ncloud Network Proxy Load Balancer에서 Proxy Protocol을 이용해 클라이언트 IP 주소를 확인하는 방법&quot; caption=&quot;&quot; %}

### Target 추가
앞에서 생성했던 서버 2대를 선택하고 [적용 Target]쪽으로 이동시킵니다.

{% include image.html file=&quot;networking/ncloud-networking-proxy-protocol-client-ip-logging-05.png&quot; width=&quot;845&quot; alt=&quot;Ncloud Network Proxy Load Balancer에서 Proxy Protocol을 이용해 클라이언트 IP 주소를 확인하는 방법&quot; caption=&quot;&quot; %}

### 설정 확인
설정 정보를 최종 확인하고 이상이 없으면 Target Group을 생성합니다.

{% include image.html file=&quot;networking/ncloud-networking-proxy-protocol-client-ip-logging-06.png&quot; width=&quot;845&quot; alt=&quot;Ncloud Network Proxy Load Balancer에서 Proxy Protocol을 이용해 클라이언트 IP 주소를 확인하는 방법&quot; caption=&quot;&quot; %}

생성된 Target Group를 확인할 수 있습니다.
{% include image.html file=&quot;networking/ncloud-networking-proxy-protocol-client-ip-logging-07.png&quot; width=&quot;845&quot; alt=&quot;Ncloud Network Proxy Load Balancer에서 Proxy Protocol을 이용해 클라이언트 IP 주소를 확인하는 방법&quot; caption=&quot;&quot; %}

## Network Proxy Load Balancer 생성
[Load Balancer]에서 [로드밸런서 생성] 버튼을 클릭하고  [네트워크 프록시 로드밸런서]를 선택합니다.

{% include image.html file=&quot;networking/ncloud-networking-proxy-protocol-client-ip-logging-08.png&quot; width=&quot;845&quot; alt=&quot;Ncloud Network Proxy Load Balancer에서 Proxy Protocol을 이용해 클라이언트 IP 주소를 확인하는 방법&quot; caption=&quot;&quot; %}

### 로드밸런서 설정
필요한 로드밸런서 설정을 선택하는데, 그 중에서 서브넷은 혹시 생성되어 있지 않으면 [서브넷 생성] 버튼을 클릭해 로드밸런서 전용 서브넷을 생성한 후에 다시 돌아옵니다. 여기서는 [10.0.4.0/24] 대역으로 설정했습니다.

{% include image.html file=&quot;networking/ncloud-networking-proxy-protocol-client-ip-logging-09.png&quot; width=&quot;845&quot; alt=&quot;Ncloud Network Proxy Load Balancer에서 
Proxy Protocol을 이용해 클라이언트 IP 주소를 확인하는 방법&quot; caption=&quot;&quot; %}

### 리스너 설정
리스너는 TCP 프로토콜에 80 포트를 선택하고 추가합니다.

{% include image.html file=&quot;networking/ncloud-networking-proxy-protocol-client-ip-logging-10.png&quot; width=&quot;845&quot; alt=&quot;Ncloud Network Proxy Load Balancer에서 
Proxy Protocol을 이용해 클라이언트 IP 주소를 확인하는 방법&quot; caption=&quot;&quot; %}

### Target Group 선택
Target Group는 위쪽에서 생성한 [Proxy-Protocol-TG] 을 선택합니다. 선택하면 해당 Target Group 설정 내용을 바로 확인할 수 있습니다.

{% include image.html file=&quot;networking/ncloud-networking-proxy-protocol-client-ip-logging-11.png&quot; width=&quot;845&quot; alt=&quot;Ncloud Network Proxy Load Balancer에서 
Proxy Protocol을 이용해 클라이언트 IP 주소를 확인하는 방법&quot; caption=&quot;&quot; %}

### 설정 확인
선택한 설정을 최종 확인하고 이상이 없으면 [로드밸런서 생성] 버튼을 클릭합니다.

{% include image.html file=&quot;networking/ncloud-networking-proxy-protocol-client-ip-logging-12.png&quot; width=&quot;845&quot; alt=&quot;Ncloud Network Proxy Load Balancer에서 
Proxy Protocol을 이용해 클라이언트 IP 주소를 확인하는 방법&quot; caption=&quot;&quot; %}

### 생성 확인
생성된 로드밸런서의 정보를 확인합니다. 특히 접속 정보와 서브넷은 이후 테스트에 사용되므로 꼭 기억하거나 메모해 두는 것이 좋습니다.

{% include image.html file=&quot;networking/ncloud-networking-proxy-protocol-client-ip-logging-13.png&quot; width=&quot;845&quot; alt=&quot;Ncloud Network Proxy Load Balancer에서 
Proxy Protocol을 이용해 클라이언트 IP 주소를 확인하는 방법&quot; caption=&quot;&quot; %}

## ACG 설정
로드밸런서 → 서버 접속이 가능하도록 서버 ACG에 규칙을 추가합니다.  
서버에 적용된 ACG의 규칙 설정 화면에서 프로토콜은 TCP,  접근소스는 로드밸런서 IP 대역인 10.0.4.0/24, 포트는 80을 입력하고 추가합니다.

{% include image.html file=&quot;networking/ncloud-networking-proxy-protocol-client-ip-logging-32.png&quot; width=&quot;845&quot; alt=&quot;Ncloud Network Proxy Load Balancer에서 
Proxy Protocol을 이용해 클라이언트 IP 주소를 확인하는 방법&quot; caption=&quot;&quot; %}

## 로드밸런서 접속 테스트
위에서 생성된 로드밸런서 접속 주소로 접속을 해보면 아래와 같은 화면을 확인할 수 있습니다.

{% include image.html file=&quot;networking/ncloud-networking-proxy-protocol-client-ip-logging-15.png&quot; width=&quot;845&quot; alt=&quot;Ncloud Network Proxy Load Balancer에서 
Proxy Protocol을 이용해 클라이언트 IP 주소를 확인하는 방법&quot; caption=&quot;&quot; %}

### Apache 접속 로그 확인
Apache 접속 로그 파일은 아래의 위치에 존재하지만, 저희는 네이버 클라우드 (Ncloud)의 상품 중 하나인 **Cloud Log Analytics**에서 로그를 수집해서 확인해보겠습니다. 
- Ubuntu Apache 로그파일 위치 : /var/log/apache2/access.log

- Cloud Log Analytics 설정 가이드 : &lt;a href=&quot;/analytics/ncloud_analytics_cloud_log_analytics_guide.html&quot; target=&quot;_blank&quot; style=&quot;word-break:break-all;&quot;&gt;https://docs.3rdeyesys.com/analytics/ncloud_analytics_cloud_log_analytics_guide.html&lt;/a&gt;

Cloud Log Analytics에서 수집한 로그를 확인해보면 위에서 설정했던 **Load Balancer의 IP 대역 (10.0.4.xx)**이 기록된 것을 확인할 수 있습니다.  

다음으로는 로드밸런서 IP가 아닌 실제 Client IP가 기록되도록 설정을 변경해 보겠습니다.

{% include image.html file=&quot;networking/ncloud-networking-proxy-protocol-client-ip-logging-16-2.png&quot; width=&quot;845&quot; alt=&quot;Ncloud Network Proxy Load Balancer에서 
Proxy Protocol을 이용해 클라이언트 IP 주소를 확인하는 방법&quot; caption=&quot;&quot; %}


## Proxy Protocol 설정
이제 실제 Client IP가 기록되도록 Proxy Protocol을 설정해보겠습니다.  
[Load Balancer] - [Target Group]에서 위에서 생성했던 Target Group를 선택하고 [TargetGroup 설정] 버튼을 클릭합니다.

{% include image.html file=&quot;networking/ncloud-networking-proxy-protocol-client-ip-logging-17.png&quot; width=&quot;845&quot; alt=&quot;Ncloud Network Proxy Load Balancer에서 
Proxy Protocol을 이용해 클라이언트 IP 주소를 확인하는 방법&quot; caption=&quot;&quot; %}

Target Group 설정 화면에서 [ProxyProtocol] 옵션을 체크하고 확인 버튼을 클릭합니다.

{% include image.html file=&quot;networking/ncloud-networking-proxy-protocol-client-ip-logging-18.png&quot; width=&quot;680&quot; alt=&quot;Ncloud Network Proxy Load Balancer에서 
Proxy Protocol을 이용해 클라이언트 IP 주소를 확인하는 방법&quot; caption=&quot;&quot; %}

위에서 정상적으로 접속이 되었던 로드밸런서 주소로 접속하면 [Bad Request] 메시지가 뜨는 것을 확인할 수 있습니다.  
다음으로는 서버 설정을 변경해야 합니다.

{% include image.html file=&quot;networking/ncloud-networking-proxy-protocol-client-ip-logging-19.png&quot; width=&quot;845&quot; alt=&quot;Ncloud Network Proxy Load Balancer에서 
Proxy Protocol을 이용해 클라이언트 IP 주소를 확인하는 방법&quot; caption=&quot;&quot; %}

## Apache 모듈 설치
Proxy Protocol을 사용할 때 필요한 Apache 모듈을 Ubuntu 서버에 설치하겠습니다.

### mod_myfixip 모듈 다운로드
아래 명령어로 mod_myfixip.c 파일을 다운로드 받습니다. 정상적으로 다운로드가 완료되면 **&apos;mod_myfixip.c&apos; saved** 라는 메시지를 확인할 수 있습니다.

```bash
~# wget --no-check-certificate https://raw.githubusercontent.com/ggrandes/apache24-modules/master/mod_myfixip.c
```

{% include image.html file=&quot;networking/ncloud-networking-proxy-protocol-client-ip-logging-24.png&quot; width=&quot;840&quot; alt=&quot;Ncloud Network Proxy Load Balancer에서 
Proxy Protocol을 이용해 클라이언트 IP 주소를 확인하는 방법&quot; caption=&quot;&quot; %}

### 모듈 설치
이어서 apxs2 -c -i mod_myfixip.c 명령어로 모듈을 설치합니다.

```bash
~# apxs2 -c -i mod_myfixip.c
```

{% include image.html file=&quot;networking/ncloud-networking-proxy-protocol-client-ip-logging-25.png&quot; width=&quot;840&quot; alt=&quot;Ncloud Network Proxy Load Balancer에서 
Proxy Protocol을 이용해 클라이언트 IP 주소를 확인하는 방법&quot; caption=&quot;&quot; %}

### myfixip.load 파일 생성
mod_myfixip 모듈을 로드하기 위한 파일을 생성하고, LoadModule 관련 코드를 추가합니다.

``` bash
~# vi /etc/apache2/mods-available/myfixip.load
```
``` apache
LoadModule myfixip_module /usr/lib/apache2/modules/mod_myfixip.so
```

{% include image.html file=&quot;networking/ncloud-networking-proxy-protocol-client-ip-logging-26.png&quot; width=&quot;840&quot; alt=&quot;Ncloud Network Proxy Load Balancer에서 
Proxy Protocol을 이용해 클라이언트 IP 주소를 확인하는 방법&quot; caption=&quot;&quot; %}

### myfixip.conf 파일 생성
mod_myfixip 모듈 환경 설정 파일을 생성하고 모듈 관련 코드를 추가합니다.  
RewriteIPAllow 항목에는 로드밸런서 IP 대역 (ex: 192.168.0.0/16, 10.31.0.0/16 등)을 입력합니다.  
여기서는 위에서 설정했던 로드밸런서 IP 대역인 `10.0.4.0/24`를 입력했습니다. 

``` bash
~# vi /etc/apache2/mods-available/myfixip.conf
```
``` apache
&lt;IfModule mod_myfixip.c&gt;
  RewriteIPResetHeader off
  RewriteIPAllow 10.0.4.0/24
&lt;/IfModule&gt;
```
{% include image.html file=&quot;networking/ncloud-networking-proxy-protocol-client-ip-logging-27.png&quot; width=&quot;840&quot; alt=&quot;Ncloud Network Proxy Load Balancer에서 
Proxy Protocol을 이용해 클라이언트 IP 주소를 확인하는 방법&quot; caption=&quot;&quot; %}

### 모듈 설치, Apache 재시작
다음 명령으로 myfixip 모듈을 설치하고 Apache를 재시작합니다.

``` bash
~# a2enmod myfixip
~# systemctl restart apache2
```
{% include image.html file=&quot;networking/ncloud-networking-proxy-protocol-client-ip-logging-28.png&quot; width=&quot;840&quot; alt=&quot;Ncloud Network Proxy Load Balancer에서 
Proxy Protocol을 이용해 클라이언트 IP 주소를 확인하는 방법&quot; caption=&quot;&quot; %}


## 최종 접속 테스트
모든 설정을 모두 마친 후에 서버에 접속해봅니다.

{% include image.html file=&quot;networking/ncloud-networking-proxy-protocol-client-ip-logging-15.png&quot; width=&quot;845&quot; alt=&quot;Ncloud Network Proxy Load Balancer에서 
Proxy Protocol을 이용해 클라이언트 IP 주소를 확인하는 방법&quot; caption=&quot;&quot; %}

## 최종 접속 로그 확인
접속 로그를 다시 확인해보면 이번에는 로드밸런서 IP가 아닌 Client IP가 기록된 것을 확인할 수 있습니다.

{% include image.html file=&quot;networking/ncloud-networking-proxy-protocol-client-ip-logging-29-2.png&quot; width=&quot;845&quot; alt=&quot;Ncloud Network Proxy Load Balancer에서 
Proxy Protocol을 이용해 클라이언트 IP 주소를 확인하는 방법&quot; caption=&quot;&quot; %}

## 참고URL

1. Proxy Protocol 설정하기
  - &lt;a href=&quot;https://guide.ncloud-docs.com/docs/networking-loadbalancer-targetgroupconsole#proxy-protocol-%EC%84%A4%EC%A0%95%ED%95%98%EA%B8%B0&quot; target=&quot;_blank&quot; style=&quot;word-break:break-all;&quot;&gt;https://guide.ncloud-docs.com/docs/networking-loadbalancer-targetgroupconsole#proxy-protocol&lt;/a&gt;

2. CentOS 서버에서 Proxy Protocol을 이용해 Client IP 확인하기
  - &lt;a href=&quot;/networking/ncloud-networking-proxy-protocol-client-ip-logging-centos.html&quot; target=&quot;_blank&quot; style=&quot;word-break:break-all;&quot;&gt;https://docs.3rdeyesys.com/networking/ncloud-networking-proxy-protocol-client-ip-logging-centos.html&lt;/a&gt;


</description>
            <pubDate>Thu, 04 Aug 2022 00:00:00 +0900</pubDate>
            <link>https://docs.3rdeyesys.com/networking/ncloud-networking-proxy-protocol-client-ip-logging-ubuntu.html</link>
            <guid isPermaLink="true">https://docs.3rdeyesys.com/networking/ncloud-networking-proxy-protocol-client-ip-logging-ubuntu.html</guid>
            
            <category>vpc</category>
            
            <category>load_balancer</category>
            
            <category>proxy</category>
            
            
        </item>
        
        <item>
            <title>Classic 환경 Cloud DB for MySQL 읽기 부하 로드밸런서로 분산시키는 방법</title>
            <description>## 개요
MySQL DB서버의 부하를 줄이기 위해 보통 읽기 전용 DB서버를 생성하게 되는데, 읽기 전용 서버를 여러대 생성해서 로드밸런서(Load Balancer)로 연결하면 읽기 부하를 분산 시키고 좀 더 안정적인 서비스가 가능해집니다.  

여기서는 Ncloud (네이버 클라우드) Classic 환경에서 관리형 DB인 Cloud DB for MySQL의 **읽기 전용 Slave DB를 로드밸런서에 연결**하고 제대로 부하가 분산되는지 확인해보겠습니다.

## 사전 준비
DB 접속과 부하 분산을 테스트할 서버가 필요합니다. 여기서는 CentOS 7.8 서버를 준비했습니다.

## DB 서버 생성
우선 [Cloud DB for MySQL] - [DB Server]에서 DB를 생성합니다.

### 서버 설정
서버 설정에서 중요한 부분은 [**고가용성 지원**] 항목입니다. Slave DB를 추가하기 위해서는 [**고가용성 지원**] 항목을 체크해야 합니다. 
혹시 고가용성 지원 없이 서버를 생성했을 경우 이후에 [**고가용성 지원**]을 설정하면 문제 없이 Slave DB를 추가할 수 있습니다.

{% include image.html file=&quot;database/ncloud-database-cloud-db-for-mysql-read-load-balancing-01.png&quot; width=&quot;845&quot; alt=&quot;Ncloud Classic 환경에서 Cloud DB for MySQL 디비의 읽기 부하를 로드밸런서로 분산시키는 방법&quot; caption=&quot;&quot; %}

### DB 설정
그 외 필요한 DB 설정을 입력합니다. 여기서 Backup 설정은 고가용성을 선택했을 경우 자동으로 사용하도록 설정됩니다.

{% include image.html file=&quot;database/ncloud-database-cloud-db-for-mysql-read-load-balancing-02.png&quot; width=&quot;845&quot; alt=&quot;Ncloud Classic 환경에서 Cloud DB for MySQL 디비의 읽기 부하를 로드밸런서로 분산시키는 방법&quot; caption=&quot;&quot; %}


## Slave DB 추가
DB 서버 생성이 완료되면 아래와 같이 [Master], [Standy Master] 2대의 서버가 생성된 것을 확인할 수 있습니다.  
Master 서버를 선택하고 [DB 관리] 메뉴에서 [**Slave 추가**]를 선택합니다.

{% include image.html file=&quot;database/ncloud-database-cloud-db-for-mysql-read-load-balancing-03.png&quot; width=&quot;845&quot; alt=&quot;Ncloud Classic 환경에서 Cloud DB for MySQL 디비의 읽기 부하를 로드밸런서로 분산시키는 방법&quot; caption=&quot;&quot; %}

### Slave DB 정보
Slave DB 서버 추가 팝업에서는 특별히 수정할 부분 없이 [예] 버튼을 클릭하면 추가 됩니다.

{% include callout_v2.html type=&quot;warning&quot; level=&quot;2&quot; content=&quot;Slave DB Server는 Master DB Server와 동일한 스펙 (DB Server 타입, 스토리지 타입, 스토리지 용량)및 DB Config 설정으로 생성됩니다. Slave DB Server 역시 Master DB Server와 동일한 요금이 청구되며, 사용한 시간으로 과금됩니다.&quot; %}

{% include image.html file=&quot;database/ncloud-database-cloud-db-for-mysql-read-load-balancing-04.png&quot; width=&quot;685&quot; alt=&quot;Ncloud Classic 환경에서 Cloud DB for MySQL 디비의 읽기 부하를 로드밸런서로 분산시키는 방법&quot; caption=&quot;&quot; %}

### 생성 완료
Slave DB를 1대 생성했으면 동일한 방법으로 하나 더 생성합니다. 
여기서는 [test-003], [test-004]라는 이름으로 생성되었습니다.

{% include image.html file=&quot;database/ncloud-database-cloud-db-for-mysql-read-load-balancing-05.png&quot; width=&quot;845&quot; alt=&quot;Ncloud Classic 환경에서 Cloud DB for MySQL 디비의 읽기 부하를 로드밸런서로 분산시키는 방법&quot; caption=&quot;&quot; %}

## ACG 설정
다음으로 방화벽 ACG를 미리 설정해야 하는데, Master DB를 선택하고 아래쪽에 있는 [**ACG**] 항목을 클릭합니다.

{% include image.html file=&quot;database/ncloud-database-cloud-db-for-mysql-read-load-balancing-06.png&quot; width=&quot;845&quot; alt=&quot;Ncloud Classic 환경에서 Cloud DB for MySQL 디비의 읽기 부하를 로드밸런서로 분산시키는 방법&quot; caption=&quot;&quot; %}

ACG 리스트에서 Cloud DB를 생성할때 자동으로 생성된 [cloud-db-OOOO]라는 이름의 ACG를 선택하고 [ACG 설정] 버튼을 클릭합니다.

{% include image.html file=&quot;database/ncloud-database-cloud-db-for-mysql-read-load-balancing-07.png&quot; width=&quot;845&quot; alt=&quot;Ncloud Classic 환경에서 Cloud DB for MySQL 디비의 읽기 부하를 로드밸런서로 분산시키는 방법&quot; caption=&quot;&quot; %}

### 규칙 설정
ACG에 설정이 필요한 규칙은 2가지입니다.  
- 부하 분산을 위한 Load Balancer -&gt; Cloud DB for MySQL로 접근을 허용하는 규칙
- 테스트를 위한 Server -&gt; Cloud DB for MySQL로 접근을 허용하는 규칙

Load Balancer -&gt; Cloud DB for MySQL로 접근을 허용하는 규칙은 Load Balancer 전용 ACG [**ncloud-load-balancer**]를 [접근 소스] 항목에 추가합니다.  

Server -&gt; Cloud DB for MySQL로 접근을 허용하는 규칙은 [접근 소스] 항목에 [Server IP] 또는 [Server에 설정된 ACG]를 입력하면 됩니다.

{% include image.html file=&quot;database/ncloud-database-cloud-db-for-mysql-read-load-balancing-08.png&quot; width=&quot;845&quot; alt=&quot;Ncloud Classic 환경에서 Cloud DB for MySQL 디비의 읽기 부하를 로드밸런서로 분산시키는 방법&quot; caption=&quot;&quot; %}

## Load Balancer 생성
마지막으로 로드밸런서를 생성해야 하는데, 로드밸런서를 생성할 때 Slave DB와 연결하려면 `네트워크 항목을 [Private IP]로 설정`해야 합니다.  
그리고 프로토콜은 TCP, 포트는 3306으로 설정하겠습니다.

{% include image.html file=&quot;database/ncloud-database-cloud-db-for-mysql-read-load-balancing-09.png&quot; width=&quot;845&quot; alt=&quot;Ncloud Classic 환경에서 Cloud DB for MySQL 디비의 읽기 부하를 로드밸런서로 분산시키는 방법&quot; caption=&quot;&quot; %}

### 서버 추가
[서버 추가] 화면에는 적용할 서버 리스트에 위에서 생성했던 Slave DB 서버가 나타나는데, 모두 선택하고 오른쪽으로 이동 시킵니다.

{% include image.html file=&quot;database/ncloud-database-cloud-db-for-mysql-read-load-balancing-10.png&quot; width=&quot;845&quot; alt=&quot;Ncloud Classic 환경에서 Cloud DB for MySQL 디비의 읽기 부하를 로드밸런서로 분산시키는 방법&quot; caption=&quot;&quot; %}

설정에 이상이 없으면 로드밸런서가 생성되고, 적용 서버의 연결 상태가 모두 [성공]으로 나타납니다.

{% include image.html file=&quot;database/ncloud-database-cloud-db-for-mysql-read-load-balancing-11.png&quot; width=&quot;845&quot; alt=&quot;Ncloud Classic 환경에서 Cloud DB for MySQL 디비의 읽기 부하를 로드밸런서로 분산시키는 방법&quot; caption=&quot;&quot; %}

## 테스트 서버 설정
읽기 부하가 제대로 분산되는지 테스트 하기 위해 준비된 서버에 [**MySQL Client**]를 설치합니다.

{% include note.html content=&quot;CentOS 7부터는 yum으로 설치하는 MySQL의 기본 데이터베이스가 MariaDB로 변경되었습니다.&quot; %}

``` bash
~# yum -y install mysql
```

{% include image.html file=&quot;database/ncloud-database-cloud-db-for-mysql-read-load-balancing-12.png&quot; width=&quot;840&quot; alt=&quot;Ncloud Classic 환경에서 Cloud DB for MySQL 디비의 읽기 부하를 로드밸런서로 분산시키는 방법&quot; caption=&quot;&quot; %}

## 부하 분산 테스트
설치된 MySQL Client를 이용해서 Load Balancer IP로 접속한 후에 접속한 DB 서버의 호스트명을 확인하는 쿼리를 실행합니다.  

여러 차례 반복해보면 아래와 같이 위에서 추가했던 Slave DB [test-003], [test-004]에 각각 접속되는 것을 확인할 수 있습니다.

``` bash
~# mysql -h {Load Balancer IP} -u {계정} -p
```

``` sql
MySQL [(none)]&gt; SELECT @@hostname;
```

### [test-003]에 접속된 상태
{% include image.html file=&quot;database/ncloud-database-cloud-db-for-mysql-read-load-balancing-13.png&quot; width=&quot;840&quot; alt=&quot;Ncloud Classic 환경에서 Cloud DB for MySQL 디비의 읽기 부하를 로드밸런서로 분산시키는 방법&quot; caption=&quot;&quot; %}

### [test-004]에 접속된 상태
{% include image.html file=&quot;database/ncloud-database-cloud-db-for-mysql-read-load-balancing-14.png&quot; width=&quot;840&quot; alt=&quot;Ncloud Classic 환경에서 Cloud DB for MySQL 디비의 읽기 부하를 로드밸런서로 분산시키는 방법&quot; caption=&quot;&quot; %}


## DB 삭제
테스트를 끝낸 DB를 삭제하려고 할 때 [Slave나 Recovery DB 서버가 있는 경우 Master DB를 삭제할 수 없습니다.]라는 메시지가 나타나는 것을 확인할 수 있습니다.  

그래서 DB를 삭제할 때는 [Slave DB]부터 삭제해야 하고, [Slave DB]를 삭제할 때에도 동시에 삭제할 수 없고 1대씩 차례로 삭제해야 합니다.

{% include image.html file=&quot;database/ncloud-database-cloud-db-for-mysql-read-load-balancing-15.png&quot; width=&quot;490&quot; alt=&quot;Ncloud Classic 환경에서 Cloud DB for MySQL 디비의 읽기 부하를 로드밸런서로 분산시키는 방법&quot; caption=&quot;&quot; %}


## 참고 URL
1. Ncloud Cloud DB for MySQL 읽기 부하 분산 설정 가이드
	- &lt;a href=&quot;https://guide.ncloud-docs.com/docs/database-database-5-2#%EC%9D%BD%EA%B8%B0-%EB%B6%80%ED%95%98-%EB%B6%84%EC%82%B0-%EC%84%A4%EC%A0%95&quot; target=&quot;_blank&quot; style=&quot;word-break:break-all;&quot;&gt;https://guide.ncloud-docs.com/docs/database-database-5-2&lt;/a&gt;

2. VPC 환경 Cloud DB for MySQL 읽기 부하를 네트워크 프록시 로드밸런서로 분산시키는 방법
	- &lt;a href=&quot;/database/ncloud-database-cloud-db-for-mysql-read-load-balancing-network-proxy-lb.html&quot; target=&quot;_blank&quot; style=&quot;word-break:break-all;&quot;&gt;https://docs.3rdeyesys.com/database/ncloud-database-cloud-db-for-mysql-read-load-balancing-network-proxy-lb.html&lt;/a&gt;   

3. VPC 환경 Cloud DB for MySQL 읽기 부하를 네트워크 로드밸런서로 분산시키는 방법
	- &lt;a href=&quot;/database/ncloud-database-cloud-db-for-mysql-read-load-balancing-network-lb.html&quot; target=&quot;_blank&quot; style=&quot;word-break:break-all;&quot;&gt;https://docs.3rdeyesys.com/database/ncloud-database-cloud-db-for-mysql-read-load-balancing-network-lb.html&lt;/a&gt;   		

</description>
            <pubDate>Wed, 20 Jul 2022 00:00:00 +0900</pubDate>
            <link>https://docs.3rdeyesys.com/database/ncloud-database-cloud-db-for-mysql-read-load-balancing.html</link>
            <guid isPermaLink="true">https://docs.3rdeyesys.com/database/ncloud-database-cloud-db-for-mysql-read-load-balancing.html</guid>
            
            <category>database</category>
            
            <category>mysql</category>
            
            <category>mariadb</category>
            
            <category>load-balancer</category>
            
            
        </item>
        
        <item>
            <title>Jenkins 서버 설치 가이드 | Ubuntu</title>
            <description>## 개요
Ncloud (네이버 클라우드)의 Classic 환경에서는 Jekins 서버 이미지를 제공하고 있지만, VPC 환경에서는 제공하지 않기에 VPC 환경 Ubuntu 서버에 Jekins 서버를 설치하는 과정을 정리해보겠습니다.

## Jenkins란
Jenkins는 지속적 통합(Continuous Integration, CI)과 지속적 배포(Continuous Delivery, CD)를 위한 대표적인 도구로 빌드, 테스트, 배포 프로세스를 자동화하여 소프트웨어 품질 향상과 개발 생산성 향상에 도움을 주는 도구입니다.

## Jenkins 특징

- 지속적 통합을 사용하여 빌드, 테스트, 배포 과정을 자동화하여 개발 생산성을 향상할 수 있습니다.
- 자동화 테스트를 통하여 소프트웨어 품질을 향상할 수 있습니다.
- 지속적인 통합을 통해 안정적인 릴리즈를 빠르게 배포할 수 있습니다.


## 설치 과정 

### 루트 인증서 설치
Jenkins의 저장소 추가시 인증서 에러가 발생할 경우를 대비해 루트 인증서를 설치 합니다.

```bash
~# apt-get -y install ca-certificates
```

{% include image.html file=&quot;dev-tools/ncloud-dev-tools-jenkins-install-guide-ubuntu-03.png&quot; width=&quot;840&quot; alt=&quot;Ncloud VPC 환경에서 Ubuntu에 Jenkins 서버를 설치하는 방법&quot; caption=&quot;&quot; %}

### 저장소 키 추가
이제 Jenkins의 패키지 저장소를 추가 하기 위한 저장소 키를 가져옵니다.

```bash
curl -fsSL https://pkg.jenkins.io/debian-stable/jenkins.io.key \
    | sudo tee /usr/share/keyrings/jenkins-keyring.asc &gt; /dev/null
```

{% include image.html file=&quot;dev-tools/ncloud-dev-tools-jenkins-install-guide-ubuntu-04.png&quot; width=&quot;840&quot; alt=&quot;Ncloud VPC 환경에서 Ubuntu에 Jenkins 서버를 설치하는 방법&quot; caption=&quot;&quot; %}

### 저장소 추가
그런다음 Jenkins의 패키지 저장소 항목을 추가 합니다.

```bash
echo deb [signed-by=/usr/share/keyrings/jenkins-keyring.asc] \
    https://pkg.jenkins.io/debian-stable binary/ | sudo tee \
    /etc/apt/sources.list.d/jenkins.list &gt; /dev/null
``` 

{% include image.html file=&quot;dev-tools/ncloud-dev-tools-jenkins-install-guide-ubuntu-05.png&quot; width=&quot;840&quot; alt=&quot;Ncloud VPC 환경에서 Ubuntu에 Jenkins 서버를 설치하는 방법&quot; caption=&quot;&quot; %}

### JAVA 설치
Jenkins를 구동하기 위해서는 JAVA가 필요하고, 추가로 fontconfig도 설치합니다.

{% include callout_v2.html type=&quot;info&quot; level=&quot;2&quot; content=&quot;※ JAVA의 경우 Jenkins최신버전을 기준으로 8 혹은 11 버전이 필요 합니다.&quot; %}

```bash
~# apt-get update
~# apt-get -y install fontconfig openjdk-11-jre
```

{% include image.html file=&quot;dev-tools/ncloud-dev-tools-jenkins-install-guide-ubuntu-06.png&quot; width=&quot;840&quot; alt=&quot;Ncloud VPC 환경에서 Ubuntu에 Jenkins 서버를 설치하는 방법&quot; caption=&quot;&quot; %}

{% include image.html file=&quot;dev-tools/ncloud-dev-tools-jenkins-install-guide-ubuntu-02.png&quot; width=&quot;840&quot; alt=&quot;Ncloud VPC 환경에서 Ubuntu에 Jenkins 서버를 설치하는 방법&quot; caption=&quot;&quot; %}


### Jenkins 설치
모든 준비가 끝났으면 Jenkins를 설치합니다.

```bash
~# apt-get -y install jenkins
```


{% include image.html file=&quot;dev-tools/ncloud-dev-tools-jenkins-install-guide-ubuntu-07.png&quot; width=&quot;840&quot; alt=&quot;Ncloud VPC 환경에서 Ubuntu에 Jenkins 서버를 설치하는 방법&quot; caption=&quot;&quot; %}


### Jenkins 서비스 시작
Jekins 서비스를 시작하고 정상 작동하고 있는지 다음과 같이 확인합니다.

```bash
~# systemctl start jenkins
~# systemctl status jenkins
```

{% include image.html file=&quot;dev-tools/ncloud-dev-tools-jenkins-install-guide-ubuntu-08.png&quot; width=&quot;840&quot; alt=&quot;Ncloud VPC 환경에서 Ubuntu에 Jenkins 서버를 설치하는 방법&quot; caption=&quot;&quot; %}


## 방화벽 ACG 설정
Jekins 서버가 사용하는 기본 포트는 8080 입니다. Ncloud 방화벽 ACG에서 8080 포트를 허용해줍니다.

{% include image.html file=&quot;dev-tools/ncloud-dev-tools-jenkins-install-guide-centos-07.png&quot; width=&quot;845&quot; alt=&quot;Ncloud VPC 환경에서 CentOS에 Jenkins 서버를 설치하는 방법&quot; caption=&quot;&quot; %}


## 초기 설정

### Port 변경

{% include callout_v2.html type=&quot;warning&quot; level=&quot;2&quot; content=&quot;Jenkins의 기본 접속 Port는 /etc/default/jenkins 의 HTTP_PORT= 항목에서 변경 할 수 있습니다.&quot; %} 

{% include image.html file=&quot;dev-tools/ncloud-dev-tools-jenkins-install-guide-ubuntu-10.png&quot; width=&quot;840&quot; alt=&quot;Ncloud VPC 환경에서 Ubuntu에 Jenkins 서버를 설치하는 방법&quot; caption=&quot;&quot; %}

### 초기 패스워드 확인

설치가 완료된 후 http://{서버 IP주소}:8080 으로 접속하면 아래의 스크린샷처럼 초기 어드민 패스워드를 입력하는 화면이 나타납니다.

{% include image.html file=&quot;dev-tools/ncloud-dev-tools-jenkins-install-guide-centos-08.png&quot; width=&quot;845&quot; alt=&quot;Ncloud VPC 환경에서 CentOS에 Jenkins 서버를 설치하는 방법&quot; caption=&quot;&quot; %}

초기 어드민 패스워드는 **/var/lib/jenkins/secrets/initialAdminPassword** 파일에 기록되어 있습니다.  
cat 명령어로 초기 패스워드를 확인합니다.

```bash
~# cat /var/lib/jenkins/secrets/initialAdminPassword
```

{% include image.html file=&quot;dev-tools/ncloud-dev-tools-jenkins-install-guide-centos-09.png&quot; width=&quot;840&quot; alt=&quot;Ncloud VPC 환경에서 CentOS에 Jenkins 서버를 설치하는 방법&quot; caption=&quot;&quot; %}

## 플러그인 설치
플러그인 설치는 추천 플러그인을 설치하는 옵션과 직접 선택해서 설치하는 옵션이 있습니다. 일단 여기서는 추천 플러그인을 선택하겠습니다.

{% include image.html file=&quot;dev-tools/ncloud-dev-tools-jenkins-install-guide-centos-10.png&quot; width=&quot;845&quot; alt=&quot;Ncloud VPC 환경에서 CentOS에 Jenkins 서버를 설치하는 방법&quot; caption=&quot;&quot; %}

추천 플러그인을 선택하면 아래와 같이 설치과정이 나타납니다.

{% include image.html file=&quot;dev-tools/ncloud-dev-tools-jenkins-install-guide-centos-11.png&quot; width=&quot;845&quot; alt=&quot;Ncloud VPC 환경에서 CentOS에 Jenkins 서버를 설치하는 방법&quot; caption=&quot;&quot; %}

직접 플러그인을 선택할 경우 아래와 같이 여러 플러그인 중에서 설치하고 싶은 플러그인을 선택할 수 있습니다.

{% include image.html file=&quot;dev-tools/ncloud-dev-tools-jenkins-install-guide-centos-12.png&quot; width=&quot;845&quot; alt=&quot;Ncloud VPC 환경에서 CentOS에 Jenkins 서버를 설치하는 방법&quot; caption=&quot;&quot; %}


## 어드민 계정 정보 입력
플러그인 설치를 마치면 아래와 같이 어드민 계정 정보를 입력하게 됩니다.

{% include image.html file=&quot;dev-tools/ncloud-dev-tools-jenkins-install-guide-centos-13.png&quot; width=&quot;845&quot; alt=&quot;Ncloud VPC 환경에서 CentOS에 Jenkins 서버를 설치하는 방법&quot; caption=&quot;&quot; %}


## 설치 완료
필요한 정보를 모두 입력하고 나면 마지막으로 Jekins URL을 확정하고 저장합니다.

{% include image.html file=&quot;dev-tools/ncloud-dev-tools-jenkins-install-guide-centos-14.png&quot; width=&quot;845&quot; alt=&quot;Ncloud VPC 환경에서 CentOS에 Jenkins 서버를 설치하는 방법&quot; caption=&quot;&quot; %}

설치가 모두 끝났습니다.

{% include image.html file=&quot;dev-tools/ncloud-dev-tools-jenkins-install-guide-centos-15.png&quot; width=&quot;845&quot; alt=&quot;Ncloud VPC 환경에서 CentOS에 Jenkins 서버를 설치하는 방법&quot; caption=&quot;&quot; %}

이제 Jekins에 접속하면 아래와 같은 화면을 확인할 수 있습니다.

{% include image.html file=&quot;dev-tools/ncloud-dev-tools-jenkins-install-guide-centos-16.png&quot; width=&quot;845&quot; alt=&quot;Ncloud VPC 환경에서 CentOS에 Jenkins 서버를 설치하는 방법&quot; caption=&quot;&quot; %}


## 참고 URL
1. Jeins Debian Packages
    - &lt;a href=&quot;https://pkg.jenkins.io/debian-stable/&quot; target=&quot;_blank&quot; style=&quot;word-break:break-all&quot;&gt;https://pkg.jenkins.io/debian-stable/&lt;/a&gt;

2. Jenkins User Documentation
    - &lt;a href=&quot;https://www.jenkins.io/doc/&quot; target=&quot;_blank&quot; style=&quot;word-break:break-all&quot;&gt;https://www.jenkins.io/doc/&lt;/a&gt;


</description>
            <pubDate>Thu, 14 Jul 2022 00:00:00 +0900</pubDate>
            <link>https://docs.3rdeyesys.com/dev-tools/ncloud-dev-tools-jenkins-server-install-guide-ubuntu.html</link>
            <guid isPermaLink="true">https://docs.3rdeyesys.com/dev-tools/ncloud-dev-tools-jenkins-server-install-guide-ubuntu.html</guid>
            
            <category>github</category>
            
            
        </item>
        
    </channel>
</rss>
